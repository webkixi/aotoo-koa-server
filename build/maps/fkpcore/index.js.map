{"version":3,"sources":["fkpcore/index.js"],"names":["app","AotooConfigs","AotooServerHooks","get","context","configs","routerOptions","prefixes","length","_","map","params","prefix","myOptions","merge","parameters","router","registerRouterPrefixes","presets","innerData","route","preset_keys","short_prefix","multi_part_prefix","filter","item","split","single_part_prefix","sort_prefixs","forEach","_routepreset","fkp","baseRoot","fs","readdirAsync","resolve","__dirname","_utilesFiles","utileFile","valideFile","utileFun","require","default","utileHand","parse","name","registerUtile","pluginRoot","pluginStat","statSync","isDirectory","_pluginFiles","pluginFile","plugin","join","plugins","registerPlugins","socketio","global","Sio","sio","Promise","promisifyAll","IGNORE_CHARS","_fkp","ctx","opts","that","isAjax","header","value","undefined","request","set","fkpInstanc","property","_name","_value","env","process","NODE_ENV","fn","apply","arguments","prototype","use","_file","firstChar","charAt","indexOf","options","instance","dfts","apis","pages","index","mapper","pluginsFolder","server","init","staticMapper","apilist","statics","bind","routepreset","existsSync","console","log","getRouter","getRoute","myfkp","next","Fetch","run"],"mappings":"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","file":"../../fkpcore/index.js","sourcesContent":["import Path from 'path'\nimport request from 'request'\n\nlet fs = require('fs')\nlet socketio = require('./modules/wsocket'); global.Sio = socketio.sio\n// let cache = require('./modules/cache');      global.Cache = cache\n// let _fetch = require('./modules/fetch');\nlet router = require('./router')\nconst Promise = require('bluebird')\nfs = Promise.promisifyAll(fs)\n\n// 内部变量\nlet innerData = {\n  route: {\n    prefix: [],\n    presets: {}\n  }\n}\n\nconst IGNORE_CHARS = ['_', '.']\n\n// 实例, fkp中间件\nfunction _fkp(ctx, opts){\n  this.ctx = ctx\n  this.opts = opts\n  const that = this\n  this.isAjax = function() {\n    return header(that.ctx, 'X-Requested-With') === 'XMLHttpRequest';\n  }\n}\n\nfunction header(ctx, name, value) {\n  if (ctx) {\n    if (value != undefined) {\n      ctx.request.set(name, value);\n    } else {\n      return ctx.request.get(name);\n    }\n  }\n}\n\nasync function registerRouterPrefixes(app) {\n  const AotooConfigs = AotooServerHooks.get().context.configs\n  if (Object.keys(AotooConfigs.routerOptions.prefixes).length) {\n    _.map(AotooConfigs.routerOptions.prefixes, async (params, prefix) => {\n      const myOptions = _.merge({}, AotooConfigs.routerOptions.parameters, params)\n      await router(app, prefix, myOptions)\n    })\n  }\n}\n\nasync function _routepreset(app) {\n  await registerRouterPrefixes(app)\n  const presets = innerData.route.presets\n  const preset_keys = Object.keys(presets)\n  const short_prefix = []\n\n  const multi_part_prefix = preset_keys.filter(item => item.split('/').length > 2)\n  const single_part_prefix = preset_keys.filter(item => item.split('/').length <= 2)\n  const sort_prefixs = [...multi_part_prefix, ...single_part_prefix]\n\n  sort_prefixs.forEach(async (prefix) => {\n    await router(app, prefix, presets[prefix])\n  })\n}\n\n// 静态, fkp()返回实例\nexport function fkp(ctx, opts){\n  let fkpInstanc = new _fkp(ctx, opts)\n  for (const property of Object.entries(fkp)) {\n    const [_name, _value] = property\n    fkpInstanc[_name] = _value\n  }\n  return fkpInstanc\n}\n\n// manual set static property or fun or some resource\nfkp.env = process.env.NODE_ENV == 'development' ? 'dev' : 'pro'\n\n// Register utile function\nfkp.utileHand = function(name, fn){\n  if (typeof fn == 'function') {\n    fkp[name] = function() {\n      if (fn && typeof fn=='function') { return fn.apply(null, [fkp, ...arguments]) }\n    }\n  }\n}\n\n// Register plugins function\nfkp.plugins = function(name, fn){\n  if (typeof fn == 'function') {\n    _fkp.prototype[name] = function() {\n      if (fn && typeof fn=='function') { return fn.apply(this, [this.ctx, ...arguments]) }\n    }\n  }\n}\n\n// as plugins, it look nice\nfkp.use = function(name, fn){\n  _fkp.prototype[name] = function() {\n    if (fn && typeof fn=='function') return fn.apply(this, [this.ctx, ...arguments])\n  }\n}\n\nfunction valideFile(_file) {\n  const firstChar = _file && _file.charAt(0)\n  return IGNORE_CHARS.indexOf(firstChar) > -1 ? false : true\n}\n\nasync function registerUtile(app) {\n  // register utile\n  const fkp = app.fkp\n  const baseRoot = './base'\n  let _utilesFiles = await fs.readdirAsync(Path.resolve(__dirname, baseRoot))\n  if (_utilesFiles && _utilesFiles.length) {\n    for (let utileFile of _utilesFiles) {\n      if (valideFile(utileFile)) {\n        let utileFun = require('./base/' + utileFile).default()\n        fkp.utileHand(Path.parse(utileFile).name, utileFun)\n      }\n    }\n  }\n}\n\nasync function registerPlugins(pluginRoot, app) {\n  const fkp = app.fkp\n  const pluginStat = fs.statSync(pluginRoot)\n  if (pluginStat.isDirectory()) {\n    let _pluginFiles = await fs.readdirAsync(pluginRoot)\n    if (_pluginFiles && _pluginFiles.length) {\n      for (let pluginFile of _pluginFiles) {\n        if (valideFile(pluginFile)) {\n          let plugin = require(Path.join(pluginRoot, pluginFile)).default(fkp)\n          fkp.plugins(Path.parse(pluginFile).name, plugin)\n        }\n      }\n    }\n\n    // let _pluginFiles = fs.readdirSync(pluginRoot)\n    // if (_pluginFiles && _pluginFiles.length) {\n    //   for (let pluginFile of _pluginFiles) {\n    //     if (valideFile(pluginFile)) {\n    //       let plugin = require(Path.join(pluginRoot, pluginFile)).default(fkp)\n    //       fkp.plugins(Path.parse(pluginFile).name, plugin)\n    //     }\n    //   }\n    // }\n  }\n}\n\nexport default async function(app, options) {\n  const instance = this\n  // =========== 注册fkp中间件 =============\n  app.fkp = fkp\n\n  let dfts = {\n    apis: options.apis,\n    pages: options.pages,      \n    index: options.index,\n    mapper: options.mapper,\n    pluginsFolder: options.pluginsFolder\n  }\n\n  // 初始化controls目录\n  router.pages(dfts.pages) \n\n  // 初始化socket.io\n  let server = socketio.init(app)  \n\n  // 传入apis\n  // const fetch = _fetch({apis: dfts.apis});     \n  // global.Fetch = fetch\n\n  fkp.staticMapper = dfts.mapper\n  fkp.router = router\n  fkp.apilist = dfts.apis\n  fkp.index = dfts.index\n  fkp.statics = instance.statics.bind(instance)\n\n\n  /**\n   * 预动态设置路由, 在plugins方法中使用\n   * @param  {String}  prefix        koa-router's prefix\n   * @param  {JSON}  routerOptions   koa-router's route\n  */\n  fkp.routepreset = async function(prefix, routerOptions) {\n    if (prefix) {\n      prefix = Path.join('/', prefix)\n      innerData.route.presets[prefix] = routerOptions\n      // prefix = Path.join('/', prefix)\n      // let presets = innerData.route.presets\n      // if (!presets[prefix]) {\n      //   presets[prefix] = true\n      //   await router(app, prefix, routerOptions)\n      // }\n    }\n\n    // if (!prefix) return\n    // if (prefix.indexOf('/')==-1) return\n    // let prefixs = innerData.route.prefix\n    // if (prefixs.indexOf(prefix)>-1) return\n    // prefixs.push(prefix)\n    // await router(app, prefix, routerOptions)\n  }\n\n\n  /*\n  =============== 注册助手方法及plugins =============\n  1、助手方法为一般的静态方法，第一个参数fkp，通过fkp.xxx调用，助手方法不能调用plugins方法\n  2、插件方法为new fkp后的对象方法，带有this的上下文，第一个参数ctx，为koa环境对象，插件方法挂载在fkp上，调用方法同样为fkp.xxx\n  =================================================*/\n\n  try {\n    // register utile\n    await registerUtile(app)\n\n    // register plugins\n    const pluginRoot = dfts.pluginsFolder\n    if ( pluginRoot && fs.existsSync(pluginRoot) ) {\n      await registerPlugins(pluginRoot, app)\n    }\n  } catch (e) {\n    console.log(e);\n  }\n  \n  // 获取当前的路由信息\n  fkp.getRouter = function(){\n    return router.getRoute(ctx)\n  }\n\n  const myfkp = fkp(null)\n  \n  // 封装koa中间件\n  app.use(async (ctx, next) => {\n    // controle层使用的fkp都是实例化的fkp\n    myfkp.ctx = ctx\n    ctx.fkp = myfkp\n\n    // 定义Fetch的上下文环境\n    Fetch.init(ctx)\n    await next()\n  })\n  \n  await _routepreset(app)\n  \n  // 初始化路由\n  await router(app)\n\n  // socketio运行时\n  socketio.run()\n  return server\n}\n"]}