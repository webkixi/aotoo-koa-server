{"version":3,"sources":["fkpcore/base/markdown/mdparse.js"],"names":["marked","require","render","Renderer","renderer","default","strLen","str","replace","length","accessVar","_createDiv","raw","prope","regDiv","regAttr","_text","exec","_attr","attrs","match","map","attr","charAt","id","substring","className","creatDiv","text","raws","split","divAry","div","join","getValue","key","val","getConfig","md_raw","cvariable","rev","rev2","rev3","cnReg","re5","tmp","tmp2","item","i","k","_","trim","v","_v","test","indexOf","_obj","find","mkmd","opts","dft","gfm","tables","breaks","pedantic","sanitize","smartLists","smartypants","isPlainObject","merge","props","token","setOptions","tokens","lexer","forEach","ii","type","depth","title","desc","nextItem","mdcnt","descript","content","imgs","img","menu","params","parser","$0","$1","regDiv2","regImg","mdMenus","regMenu","regMenu1","menus","cap","xxx","href","push","e","module","exports"],"mappings":";;;;;;;;;;;;AAAA,IAAMA,SAASC,QAAQ,UAAR,CAAf;AACA,IAAMC,SAAS,IAAIF,OAAOG,QAAX,EAAf;AACA,IAAMC,WAAWH,QAAQ,kBAAR,EAA4BI,OAA5B,CAAoCH,MAApC,CAAjB;;AAEA,SAASI,MAAT,CAAgBC,GAAhB,EAAoB;AAClB,SAAOA,IAAIC,OAAJ,CAAY,eAAZ,EAA4B,KAA5B,EAAmCC,MAA1C;AACD;;AAEA;;;;;;AAMD,IAAMC,YAAY,CACd,MADc,EAEd,MAFc,EAGd,KAHc,EAId,IAJc,EAKd,QALc,EAMd,MANc,EAOd,EAAC,MAAM,MAAP,EAPc,EAOI;AAClB,EAAC,MAAM,QAAP,EARc,CAAlB;;AAYA,SAASC,UAAT,CAAoBC,GAApB,EAAwB;AACtB,MAAIC,QAAQ,EAAZ;AACA;AACA,MAAMC,SAAS,sCAAf;;AAEA,MAAMC,UAAU,gBAAhB;AACA,MAAMC,QAAQF,OAAOG,IAAP,CAAYL,GAAZ,CAAd;AACA,MAAII,KAAJ,EAAW;AACT,QAAME,QAAQF,MAAM,CAAN,CAAd;AACA,QAAMG,QAAQD,MAAME,KAAN,CAAYL,OAAZ,CAAd;AACA,QAAII,SAASA,MAAMV,MAAnB,EAA2B;AACzBU,YAAME,GAAN,CAAW,gBAAQ;AACjB,YAAIC,KAAKC,MAAL,CAAY,CAAZ,KAAkB,GAAtB,EAA2BV,MAAMW,EAAN,GAAWF,KAAKG,SAAL,CAAe,CAAf,CAAX;AAC3B,YAAIH,KAAKC,MAAL,CAAY,CAAZ,KAAkB,GAAtB,EAA2B;AACzB,cAAI,CAACV,MAAMa,SAAX,EAAsBb,MAAMa,SAAN,GAAkBJ,KAAKG,SAAL,CAAe,CAAf,CAAlB,CAAtB,KACK;AACHZ,kBAAMa,SAAN,IAAmB,MAAKJ,KAAKG,SAAL,CAAe,CAAf,CAAxB;AACD;AACF;AACF,OARD;AASA,aAAO,eAAaZ,MAAMW,EAAN,IAAU,EAAvB,IAA2B,WAA3B,IAAwCX,MAAMa,SAAN,IAAiB,EAAzD,IAA6D,UAApE;AACD,KAXD,MAWO;AACL,aAAO,aAAP;AACD;AACF;AACF;;AAED,SAASC,QAAT,CAAkBf,GAAlB,EAAsB;AACpB,MAAIA,OAAO,QAAOA,GAAP,uDAAOA,GAAP,MAAc,QAAzB,EAAkC;AAChC,WAAOD,WAAWC,IAAIgB,IAAf,CAAP;AACD,GAFD,MAEO;AACLhB,UAAMA,IAAIJ,OAAJ,CAAY,mBAAZ,EAAiC,EAAjC,CAAN;AACAI,UAAMA,IAAIJ,OAAJ,CAAY,gBAAZ,EAA8B,KAA9B,CAAN;AACA,QAAIqB,OAAOjB,IAAIkB,KAAJ,CAAU,KAAV,CAAX;AACA,QAAID,KAAKpB,MAAL,GAAc,CAAlB,EAAqB;AACnB,UAAIsB,SAASF,KAAKR,GAAL,CAAS,UAASW,GAAT,EAAa;AACjC,eAAOrB,WAAWqB,GAAX,CAAP;AACD,OAFY,CAAb;AAGA,aAAOD,OAAOE,IAAP,CAAY,IAAZ,CAAP;AACD,KALD,MAKO;AACL,aAAOtB,WAAWkB,KAAK,CAAL,CAAX,CAAP;AACD;AACF;AACF;;AAED,SAASK,QAAT,CAAkBC,GAAlB,EAAuBC,GAAvB,EAA2B;AACzB,MAAID,OAAOC,GAAX,EAAgB;AACd,QAAID,OAAO,MAAX,EAAmB;AACjB,aAAOC,IAAIN,KAAJ,CAAU,UAAV,CAAP;AACD,KAFD,MAEO;AACL,aAAOM,GAAP;AACD;AACF;AACF;;AAED,SAASC,SAAT,CAAmBC,MAAnB,EAA2BC,SAA3B,EAAqC;AACnC,MAAMC,MAAM,2CAAZ;AACA,MAAMC,OAAO,+BAAb;AACA,MAAMC,OAAO,2CAAb,CAHmC,CAGwB;AAC3D,MAAMC,QAAQ,iCAAd,CAJmC,CAIgB;;AAEnD,MAAMC,MAAM,yCAAZ;;AAEA,MAAIC,MAAMP,OAAOlB,KAAP,CAAaoB,GAAb,CAAV;AACA,MAAIK,OAAOA,IAAI,CAAJ,CAAX,EAAmB;AACjBA,UAAMA,IAAI,CAAJ,EAAOrC,OAAP,CAAe,SAAf,EAA0B,EAA1B,CAAN;AACA,QAAIsC,OAAOD,IAAIzB,KAAJ,CAAUqB,IAAV,CAAX;AACA,QAAIK,IAAJ,EAAU;AACRA,WAAKzB,GAAL,CAAS,UAAS0B,IAAT,EAAeC,CAAf,EAAiB;AACxB,YAAMH,MAAME,KAAKjB,KAAL,CAAW,GAAX,CAAZ;AACA,YAAMmB,IAAIC,EAAEC,IAAF,CAAON,IAAI,CAAJ,CAAP,CAAV;AACA,YAAMO,IAAIF,EAAEC,IAAF,CAAON,IAAI,CAAJ,CAAP,CAAV;AACA,YAAMQ,KAAKX,KAAKY,IAAL,CAAUF,CAAV,CAAX;AACA,YAAI,CAACT,MAAMW,IAAN,CAAWL,CAAX,CAAD,IAAkBvC,UAAU6C,OAAV,CAAkBN,CAAlB,IAAqB,CAAC,CAA5C,EAA+C;AAC7C,cAAII,EAAJ,EAAQd,UAAUU,CAAV,IAAef,SAASe,CAAT,EAAYG,CAAZ,CAAf;AACT,SAFD,MAEO;AACL,cAAMI,OAAON,EAAEO,IAAF,CAAO/C,SAAP,EAAkBuC,CAAlB,CAAb;AACA,cAAIO,IAAJ,EAAU;AACR,gBAAIH,EAAJ,EAAQd,UAAUiB,KAAKP,CAAL,CAAV,IAAqBf,SAASsB,KAAKP,CAAL,CAAT,EAAkBG,CAAlB,CAArB;AACT;AACF;AACF,OAbD;AAcD;AACDd,aAASA,OAAO9B,OAAP,CAAegC,GAAf,EAAmB,EAAnB,CAAT;AACD;AACD,SAAO,CAAEF,MAAF,EAAUC,SAAV,CAAP;AACD;;AAED,SAASmB,IAAT,CAAc9C,GAAd,EAAmB+C,IAAnB,EAAwB;AAAI;AAC1B,MAAIC,MAAM;AACRxD,cAAUA,QADF;AAERyD,SAAK,IAFG;AAGRC,YAAQ,IAHA;AAIRC,YAAQ,KAJA;AAKRC,cAAU,KALF;AAMRC,cAAU,IANF;AAORC,gBAAY,KAPJ;AAQRC,iBAAa;AARL,GAAV;;AAWA,MAAIjB,EAAEkB,aAAF,CAAgBT,IAAhB,CAAJ,EAA2B;AACzBC,UAAMV,EAAEmB,KAAF,CAAQ,EAAR,EAAYT,GAAZ,EAAiBD,IAAjB,CAAN;AACD;;AAED,MAAIW,QAAQ,EAAZ;AAAA,MAAgBC,cAAhB;;AAhBsB,mBAiBMlC,UAAUzB,GAAV,EAAe,EAAf,CAjBN;AAAA;AAAA,MAiBhB0B,MAjBgB;AAAA,MAiBRC,SAjBQ;;AAmBtBvC,SAAOwE,UAAP,CAAkBZ,GAAlB;AACA,MAAMa,SAASzE,OAAO0E,KAAP,CAAapC,MAAb,CAAf;AACAmC,SAAOE,OAAP,CAAe,UAAS5B,IAAT,EAAe6B,EAAf,EAAkB;AAC/B,YAAQ7B,KAAK8B,IAAb;AACE,WAAK,SAAL;AACE,YAAI9B,KAAK+B,KAAL,IAAc,CAAd,IAAmB,CAACR,MAAMS,KAA9B,EAAqC;AACnCT,gBAAMS,KAAN,GAAchC,KAAKnB,IAAnB;AACD;AACD;AACF,WAAK,kBAAL;AACE,YAAI,CAAC0C,MAAMU,IAAX,EAAiB;AACf,cAAMC,WAAWR,OAAOG,KAAG,CAAV,CAAjB;AACAN,gBAAMU,IAAN,GAAazC,UAAUyC,IAAV,IAAkBC,SAASrD,IAAxC;AACD;AACD;AAXJ;AAaD,GAdD;AAeA,MAAIsD,QAAQ;AACVH,WAAO,EADG;AAEVI,cAAU,EAFA;AAGVC,aAAS,EAHC;AAIVC,UAAM,EAJI;AAKVC,SAAK,EALK;AAMVC,UAAM,EANI;AAOVC,YAAQ;AAPE,GAAZ;;AAUA,MAAI;AACFN,UAAMH,KAAN,GAAeT,MAAMS,KAAN,IAAeT,MAAMS,KAAN,CAAYvE,OAAZ,CAAoB,YAApB,EAAkC,EAAlC,CAAhB,IAA0D,SAAxE;AACA0E,UAAMC,QAAN,GAAiBb,MAAMU,IAAvB;AACAzC,cAAUyC,IAAV,GAAiBzC,UAAUyC,IAAV,IAAkBV,MAAMU,IAAzC;;AAEA,QAAII,UAAUpF,OAAOyF,MAAP,CAAchB,MAAd,CAAd;;AAEA;AACA,QAAM3D,SAAS,+BAAf;AACAsE,cAAUA,QAAQ5E,OAAR,CAAiBM,MAAjB,EAAyB,UAAC4E,EAAD,EAAKC,EAAL,EAAY;AAAE,aAAOhE,SAASgE,KAAG,IAAZ,CAAP;AAA0B,KAAjE,CAAV;;AAEA,QAAMC,UAAU,0BAAhB;AACAR,cAAUA,QAAQ5E,OAAR,CAAiBoF,OAAjB,EAA0B,UAACF,EAAD,EAAKC,EAAL,EAAY;AAAE,aAAO,SAAOhE,SAASgE,KAAG,IAAZ,CAAP,GAAyB,OAAhC;AAAyC,KAAjF,CAAV;;AAGA;AACA,QAAME,SAAS,iDAAf;AACA,QAAMR,OAAOD,QAAQhE,KAAR,CAAcyE,MAAd,CAAb;AACA,QAAIR,IAAJ,EAAU;AACRH,YAAMG,IAAN,GAAaA,IAAb;AACAH,YAAMI,GAAN,GAAaD,KAAK,CAAL,CAAb;AACD;;AAED;AACA,QAAIS,UAAU,CAAC,oBAAD,CAAd;AACA,QAAMC,UAAU,iDAAhB;AACA,QAAMC,WAAW,8BAAjB;AACA,QAAMC,QAAQb,QAAQhE,KAAR,CAAc2E,OAAd,CAAd;AACA,QAAIE,KAAJ,EAAW;AACTA,YAAM5E,GAAN,CAAW,gBAAQ;AACjB,YAAM6E,MAAMF,SAAS/E,IAAT,CAAc8B,IAAd,CAAZ;AACA,YAAImD,GAAJ,EAAS;AAAA,kDACoBA,GADpB;AAAA,cACAC,GADA;AAAA,cACKC,IADL;AAAA,cACWrB,KADX;;AAEPe,kBAAQO,IAAR,CAAa,oBAAkBD,QAAM,EAAxB,IAA4B,IAA5B,IAAmCrB,SAAO,EAA1C,IAAgD,WAA7D;AACD;AACF,OAND;AAOAe,cAAQO,IAAR,CAAa,OAAb;AACAnB,YAAMK,IAAN,GAAaO,QAAQ7D,IAAR,CAAa,IAAb,CAAb;AACD;;AAEDiD,UAAMM,MAAN,GAAgBjD,SAAhB;AACA2C,UAAME,OAAN,GAAgBA,OAAhB;AACA,WAAOF,KAAP;AACD,GA3CD,CA2CE,OAAOoB,CAAP,EAAU;AACV,UAAMA,CAAN;AACD;AACF;AACDC,OAAOC,OAAP,GAAiB9C,IAAjB","file":"../../../../fkpcore/base/markdown/mdparse.js","sourcesContent":["const marked = require('./marked')\nconst render = new marked.Renderer()\nconst renderer = require('./markdownrender').default(render)\n\nfunction strLen(str){\n  return str.replace(/[^\\x00-\\xff]/g,\"aaa\").length;\n}\n\n /*\n  * markdown解析白名单\n  * markdown扩展语法中的自定义变量，一般用于数据库存储\n  * 匹配 `@@@` 内的内容\n  * 白名单内容做为 json 传递到后端\n  */\nconst accessVar = [\n    'tags',\n    'cats',\n    'css',\n    'js',\n    'author',\n    'desc',\n    {'分类': 'cats'},   //支持中文 key\n    {'作者': 'author'}\n]\n\n\nfunction _createDiv(raw){\n  let prope = {}\n  // const regDiv = /^ *(<>|&lt;&gt;)?([\\.\\#]*(\\S+)?) *(?:\\n+|$)/ig\n  const regDiv = /^ *(<>)?([\\.\\#]*(\\S+)?) *(?:\\n+|$)/ig\n  \n  const regAttr = /[\\.\\#](\\w+)?/ig\n  const _text = regDiv.exec(raw)\n  if (_text) {\n    const _attr = _text[2]\n    const attrs = _attr.match(regAttr)\n    if (attrs && attrs.length) {\n      attrs.map( attr => {\n        if (attr.charAt(0) == '#') prope.id = attr.substring(1)\n        if (attr.charAt(0) == '.') {\n          if (!prope.className) prope.className = attr.substring(1)\n          else {\n            prope.className += ' '+ attr.substring(1)\n          }\n        }\n      })\n      return '<div id=\"'+(prope.id||'')+'\" class=\"'+(prope.className||'')+'\"></div>'\n    } else {\n      return '<div></div>'\n    }\n  }\n}\n\nfunction creatDiv(raw){\n  if (raw && typeof raw == 'object'){\n    return _createDiv(raw.text)\n  } else {\n    raw = raw.replace(/(<\\/p>|<\\/li>)?/ig, '')\n    raw = raw.replace(/<br>&lt;&gt;/ig, '@@@')\n    var raws = raw.split('@@@')\n    if (raws.length > 1) {\n      var divAry = raws.map(function(div){\n        return _createDiv(div)\n      })\n      return divAry.join('\\n')\n    } else {\n      return _createDiv(raws[0])\n    }\n  }\n}\n\nfunction getValue(key, val){\n  if (key && val) {\n    if (key == 'tags') {\n      return val.split(/[,|' ']/g)\n    } else {\n      return val\n    }\n  }\n}\n\nfunction getConfig(md_raw, cvariable){\n  const rev = /^(@{3,}) *\\n?([\\s\\S]*) *\\n+\\1 *(?:\\n+|$)/i;\n  const rev2 = /(.*)(?: *\\:(.+) *(?:\\n+|$))/ig;\n  const rev3 = /^[\\w\\-\\u4e00-\\u9fa5\\uFE30-\\uFFA0\\/\\\\\\.]+/i;  //检测合法的key, value\n  const cnReg = /^[\\u4e00-\\u9fa5\\uFE30-\\uFFA0]+$/;   // 检测中文\n\n  const re5 = /^ *(['\"]?\\w*['\"]?) *\\: *(['\"]?\\w*['\"]?)/\n\n  let tmp = md_raw.match(rev);\n  if (tmp && tmp[2]) {\n    tmp = tmp[2].replace(/['\" ]/ig, '')\n    let tmp2 = tmp.match(rev2)\n    if (tmp2) {\n      tmp2.map(function(item, i){\n        const tmp = item.split(':')\n        const k = _.trim(tmp[0])\n        const v = _.trim(tmp[1])\n        const _v = rev3.test(v)\n        if (!cnReg.test(k) && accessVar.indexOf(k)>-1 ){\n          if (_v) cvariable[k] = getValue(k, v)\n        } else {\n          const _obj = _.find(accessVar, k);\n          if (_obj) {\n            if (_v) cvariable[_obj[k]] = getValue(_obj[k], v)\n          }\n        }\n      })\n    }\n    md_raw = md_raw.replace(rev,'');\n  }\n  return [ md_raw, cvariable ]\n}\n\nfunction mkmd(raw, opts){   // out\n  let dft = {\n    renderer: renderer,\n    gfm: true,\n    tables: true,\n    breaks: false,\n    pedantic: false,\n    sanitize: true,\n    smartLists: false,\n    smartypants: false\n  }\n\n  if (_.isPlainObject(opts)) {\n    dft = _.merge({}, dft, opts)\n  }\n\n  let props = {}, token\n  let [ md_raw, cvariable ] = getConfig(raw, {})\n\n  marked.setOptions(dft)\n  const tokens = marked.lexer(md_raw)\n  tokens.forEach(function(item, ii){\n    switch (item.type) {\n      case 'heading':\n        if (item.depth == 1 && !props.title) {\n          props.title = item.text\n        }\n        break;\n      case 'blockquote_start':\n        if (!props.desc) {\n          const nextItem = tokens[ii+1]\n          props.desc = cvariable.desc || nextItem.text\n        }\n        break;\n    }\n  })\n  let mdcnt = {\n    title: '',\n    descript: '',\n    content: '',\n    imgs: [],\n    img: '',\n    menu: '',\n    params: ''\n  }\n  \n  try {\n    mdcnt.title = (props.title && props.title.replace(/ \\{(.*)\\}/g, '')) || '还没有想好标题'\n    mdcnt.descript = props.desc\n    cvariable.desc = cvariable.desc || props.desc\n\n    let content = marked.parser(tokens)\n\n    // 插入div\n    const regDiv = /<p>&lt;&gt;(.*)? *(?:\\n+|$)/ig\n    content = content.replace( regDiv, ($0, $1) => { return creatDiv($1+'\\n') } )\n\n    const regDiv2 = /<li><>(.*)? *(?:\\n+|$)/ig\n    content = content.replace( regDiv2, ($0, $1) => { return '<li>'+creatDiv($1+'\\n')+'</li>' } )\n    \n\n    // 首图、图集\n    const regImg = /<img [.]*(?:src=(['|\"]?([^ |>]*)['|\"]?)) [.]*/ig\n    const imgs = content.match(regImg)\n    if (imgs) {\n      mdcnt.imgs = imgs\n      mdcnt.img  = imgs[0]\n    }\n\n    // 菜单\n    let mdMenus = ['<ul class=\"mdmenu>']\n    const regMenu = /<(h[2]) *(?:id=['\"]?(.*?)['\"]?) *>(.*?)<\\/\\1>/ig\n    const regMenu1 = /id=['\"]?([^>]*)['\"] *>(.*)</i\n    const menus = content.match(regMenu)\n    if (menus) {\n      menus.map( item => {\n        const cap = regMenu1.exec(item)\n        if (cap) {\n          const [xxx, href, title] = cap\n          mdMenus.push('<li><a href=\"#'+(href||'')+'\">'+ (title||'') + '</a></li>')\n        }\n      })\n      mdMenus.push('</ul>')\n      mdcnt.menu = mdMenus.join('\\n')\n    }\n\n    mdcnt.params  = cvariable;\n    mdcnt.content = content\n    return mdcnt\n  } catch (e) {\n    throw e\n  }\n}\nmodule.exports = mkmd\n"]}