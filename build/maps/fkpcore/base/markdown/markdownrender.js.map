{"version":3,"sources":["fkpcore/base/markdown/markdownrender.js"],"names":["render","link","href","title","text","config","id","cls","options","sanitize","prot","decodeURIComponent","unescape","replace","toLowerCase","e","indexOf","rtn","customParse","out","whiteListProps","hr","xhtml","image","heading","level","raw","test","_","uniqueId","headerPrefix","class","desc","listitem","ckboxStr","list","body","ordered","asset","type","template","div","excute","has","Excute","_id","tmp","SAX","append","whiteListPropsAry","re","re_g","re_g_li","re_whiteList","getAsset","str","attrObj","gatherAry","match","attrs","validAttrs","forEach","item","ii","kv","split","spec","tmp_str","length","_obj","props"],"mappings":"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","file":"../../../../fkpcore/base/markdown/markdownrender.js","sourcesContent":["// var marked = require('marked')\n// var render = new marked.Renderer()\nvar whiteListPropsAry = ['id', 'class', 'div', 'excute'];\nvar re = / *\\{(.*?)\\} *(?:\\n+|$)/;    // \"fjdskg  {abc: xxx} {xyz: yyy}\" 取 \" {....}\"\nvar re_g = / *\\{(.*)\\}/g;\nvar re_g_li = /<li>(\\{.*?\\})\\s*<\\/li>\\s*/;\nvar re_whiteList = / *['|\"]?(id|class|div|desc)['|\"]? *: *['\"\\w@;: \\-_\\u0391-\\uFFE5]+/ig;    //只允许id 和 class\n\n\n// function escape(html, encode) {\n//   return html\n//     .replace(!encode ? /&(?!#?\\w+;)/g : /&/g, '&amp;')\n//     .replace(/</g, '&lt;')\n//     .replace(/>/g, '&gt;')\n//     .replace(/\"/g, '&quot;')\n//     .replace(/'/g, '&#39;');\n// }\n\n// function unescape(html) {\n// \t// explicitly match decimal, hex, and named HTML entities\n//   return html.replace(/&(#(?:\\d+)|(?:#x[0-9A-Fa-f]+)|(?:\\w+));?/g, function(_, n) {\n//     n = n.toLowerCase();\n//     if (n === 'colon') return ':';\n//     if (n.charAt(0) === '#') {\n//       return n.charAt(1) === 'x'\n//         ? String.fromCharCode(parseInt(n.substring(2), 16))\n//         : String.fromCharCode(+n.substring(1));\n//     }\n//     return '';\n//   });\n// }\n\n\n// 解析类似JSON的字符串，并合并成新的属性JSON\nfunction getAsset(str) {\n  var attrObj = {}\n  const gatherAry = str.match(re)\n  if (gatherAry) {\n    var attrs = unescape(gatherAry[0])\n    attrs = attrs.replace(/['\" ]/ig, '')\n    var validAttrs = attrs.match(re_whiteList)\n    if (validAttrs) {\n      validAttrs.forEach( function(item, ii){\n        const kv = item.split(':');\n        attrObj[kv[0]] = kv[1]\n      })\n    }\n  }\n  return attrObj\n}\n\n// 解析自定义的属性数据\nfunction customParse(str, spec){\n  var tmp_str = str;\n  if (spec==='ul'){\n    str = _.unescape(str)\n    var config = str.match(re_g_li)\n    if (config && config.length) {\n      str = str.replace(config[0],'')\n      tmp_str = str\n      var _obj = getAsset(config[1])\n      return [tmp_str, _obj]\n    }\n  }else{\n    tmp_str = tmp_str.replace(re_g, '')\n    var _obj = getAsset(str);\n    return [tmp_str, _obj];\n  }\n}\n\nfunction whiteListProps(props, type){\n  var str = '';\n  for (var item in props){\n    switch (item) {\n      case 'div':\n        break;\n      default:\n        if (whiteListPropsAry.indexOf(item)>-1) str += ' '+item+'=\"'+props[item]+'\"'\n    }\n  }\n  return str;\n}\n\nexport default function(render){\n  render.link = function(href, title, text) {\n    var config = {}\n    var id = \"\"\n    var cls = \"\"\n\n    if (this.options.sanitize) {\n      try {\n        var prot = decodeURIComponent(unescape(href)) .replace(/[^\\w:]/g, '') .toLowerCase();\n      } catch (e) {\n        return\n      }\n      if (prot.indexOf('javascript:') === 0 || prot.indexOf('vbscript:') === 0) return\n    }\n\n    if (title) {\n      if (title.indexOf(' {')>-1){\n        var rtn = customParse(title)\n        title = rtn[0]\n        config = rtn[1]\n      } else config={}\n    }\n\n    var out = '<a'+ whiteListProps(config) +' href=\"' + href + '\"';\n\n    if (title) {\n      out += ' title=\"' + title + '\"';\n    }\n    out += '>' + text + '</a>';\n    return out;\n  };\n\n  render.hr = function(cls) {\n    if (cls) {\n      return this.options.xhtml ? '<hr class=\"'+cls+'\"/>\\n' : '<hr class=\"'+cls+'\">\\n';\n    } else {\n      return this.options.xhtml ? '<hr/>\\n' : '<hr>\\n';\n    }\n  };\n\n  render.image = function(href, title, text) {\n    var config = {}\n    var id = \"\"\n    var cls = \"\"\n\n    if (title) {\n      if (title.indexOf(' {')>-1){\n        var rtn = customParse(title)\n        title = rtn[0]\n        config = rtn[1]\n      } else config={}\n    }\n\n    var out = '<img' + whiteListProps(config) + ' src=\"' + href + '\" alt=\"' + text + '\"';\n    if (title) out += ' title=\"' + title + '\"'\n    out += this.options.xhtml ? '/>' : '>';\n    return out;\n  };\n\n  render.heading = function (text, level, raw) {\n    var config={};\n\n    if (raw) {\n      if (raw.indexOf(' {')>-1){\n        var rtn = customParse(raw)\n        text = rtn[0]\n        config = rtn[1]\n      } else config={}\n    }\n\n    // var id = config.id || this.options.headerPrefix + raw.toLowerCase().replace(/[^\\\\w]+/g, '-')\n    var id;\n    if (/[\\u4e00-\\u9fa5]/g.test(raw)) id = config.id || _.uniqueId('fkp-anchor-')\n    else {\n      id = config.id || this.options.headerPrefix + raw.toLowerCase().replace(/[^\\\\w]+/g, '-')\n    }\n    if (!id || id==='-') id=_.uniqueId('fkp-anchor-')\n    var cls = config.class ? ' class=\"'+config.class+'\"' : ''\n    var desc = config.desc ? '<small>'+config.desc+'</small>':''\n    return '<h' + level + ' id=\"' + id + '\"' + cls + '>' + text + desc + '</h' + level + '>';\n  }\n\n  render.listitem = function(text) {\n    var id='';\n    var cls='';\n    var config;\n\n    if (text) {\n      if (text.indexOf(' {')>-1){\n        var rtn = customParse(text)\n        text = rtn[0]\n        config = rtn[1]\n      } else config={}\n    }\n\n    var ckboxStr = ''\n    if (text.indexOf('[]')===0){\n      text = text.replace('[]','')\n      ckboxStr = '<input type=\"checkbox\">'\n    }\n    if (text.indexOf('[x]')===0){\n      text = text.replace('[x]','')\n      ckboxStr = '<input type=\"checkbox\" checked>'\n    }\n    return '<li' + whiteListProps(config) +'>' + ckboxStr + text + '</li>\\n';\n  }\n\n  render.list = function (body, ordered) {\n    var asset = {}\n    var id='';\n    var cls='';\n\n    if (body) {\n      if (body.indexOf('<li>{')>-1){\n        var rtn = customParse(body, 'ul')\n        if (rtn) {\n          body = rtn[0]\n          asset = rtn[1]\n        }\n      }\n    }\n\n    var type = ordered ? 'ol' : 'ul';\n    var template = '';\n\n    if (asset.div){\n      template = '<' + type +'>' + body + '</' + type + '>';\n      if (body) template = '<div '+ whiteListProps(asset, 'ul') +'>' + template + '</div>'\n      else {\n        template = '<div '+ whiteListProps(asset, 'ul') +'></div>';\n      }\n      return template;\n    }\n    else if(asset.excute){\n      if (_.has(Excute, asset.excute)){\n        let _id = _.uniqueId('excute')\n        let tmp = {}\n        tmp[_id] = Excute[asset.excute]\n        SAX.append('Excute', tmp)\n        template = '<div '+ whiteListProps(asset, 'ul') +'>~~'+_id+'~~</div>'\n        return template\n      }\n    }\n    else {\n      template = '<' + type + whiteListProps(asset) +'>' + body + '</' + type + '>'\n      return template\n    }\n  }\n\n  return render\n}\n"]}