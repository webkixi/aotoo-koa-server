{"version":3,"sources":["fkpcore/modules/wsocket.js"],"names":["noop","params","Server","require","http","socket_config","io","sio","on","off","emit","use","ioof","path","of","run","wspush","name","msg","wsuse","cb","wson","scfg","websocket","app","_server_","createServer","callback","mkon","socket","forEach","item","data","console","log","module","exports","init"],"mappings":";;;;;;;;AAAA,IAAIA,OAAO,SAAPA,IAAO,CAASC,MAAT,EAAiB,CAAE,CAA9B;AACA,IAAIC,SAASC,QAAQ,WAAR,CAAb;AACA,IAAIC,OAAOD,QAAQ,MAAR,CAAX;AACA,IAAIE,gBAAgB,EAApB;AACA,IAAIC,EAAJ;AAAA,IAAQC,MAAM;AACVC,MAAIR,IADM;AAEVS,OAAKT,IAFK;AAGVU,QAAMV,IAHI;AAIVW,OAAKX;AAJK,CAAd;;AAOA,SAASY,IAAT,CAAcN,EAAd,EAAiB;AACf,SAAO,UAAUO,IAAV,EAAgB;AACrB,QAAIP,EAAJ,EAAO;AACLA,SAAGQ,EAAH,CAAMD,IAAN;AACAE;AACD;AACF,GALD;AAMD;;AAED,SAASC,MAAT,CAAgBV,EAAhB,EAAoB;AAClB,SAAO,UAAUW,IAAV,EAAgBC,GAAhB,EAAqB;AAC1BZ,OAAGI,IAAH,CAAQO,IAAR,EAAcC,GAAd;AACD,GAFD;AAGD;;AAED,SAASC,KAAT,CAAeb,EAAf,EAAmB;AACjB,SAAO,UAASc,EAAT,EAAa;AAClB,QAAId,EAAJ,EAAQ,OAAOA,GAAGK,GAAH,CAAOS,EAAP,CAAP;AACT,GAFD;AAGD;;AAED,SAASC,IAAT,GAAgB;AAAG;AACjB,MAAIC,OAAOjB,aAAX;AACA,SAAO,UAASY,IAAT,EAAeG,EAAf,EAAmB;AACxB,QAAI,OAAOA,EAAP,IAAa,UAAjB,EAA6BE,KAAKL,IAAL,IAAaG,EAAb;AAC9B,GAFD;AAGD;;AAED,SAASG,SAAT,CAAmBC,GAAnB,EAAuB;AACrB,MAAIF,OAAOjB,aAAX;AACA,MAAIoB,WAAWrB,KAAKsB,YAAL,CAAkBF,IAAIG,QAAJ,EAAlB,CAAf;AACArB,OAAK,IAAIJ,MAAJ,CAAWuB,QAAX,CAAL;;AAEAlB,QAAM;AACJC,QAAIa,MADA;AAEJP,QAAIF,KAAKN,EAAL,CAFA;AAGJI,UAAMM,OAAOV,EAAP,CAHF;AAIJK,SAAKQ,MAAMb,EAAN;AAJD,GAAN;;AAOA,SAAOmB,QAAP;AACD;;AAED,SAASG,IAAT,CAAcC,MAAd,EAAsB;AACpB;AACA,sBAAYxB,aAAZ,EAA2ByB,OAA3B,CAAoC,UAASC,IAAT,EAAe;AACjD,QAAIX,KAAKf,cAAc0B,IAAd,CAAT;AACA,QAAI,OAAOX,EAAP,IAAa,UAAjB,EAA6B;AAC3BS,aAAOrB,EAAP,CAAUuB,IAAV,EAAgB,UAASC,IAAT,EAAe;AAC7BZ,WAAGY,IAAH,EAASH,MAAT;AACD,OAFD;AAGD;AACF,GAPD;;AASA;AACA;AACA;AACA;AACA;AACD;;AAED;AACA;AACA;AACA;AACA;AACA;;AAEA,SAASd,GAAT,GAAc;AACZ,MAAIT,EAAJ,EAAO;AACLA,OAAGE,EAAH,CAAM,YAAN,EAAoB,UAASqB,MAAT,EAAgB;AAClCD,WAAKC,MAAL;AACA;AACA;AACA;AACAA,aAAOrB,EAAP,CAAU,YAAV,EAAwB,YAAU;AAChCyB,gBAAQC,GAAR,CAAY,iBAAZ;AACD,OAFD;AAGD,KARD;AASD;AACF;;AAEDC,OAAOC,OAAP,GAAiB;AACfC,QAAMd,SADS;AAEfT,MAAIF,KAAKN,EAAL,CAFW;AAGfS,OAAKA,GAHU;AAIfR,OAAKA;AAJU,CAAjB","file":"../../../fkpcore/modules/wsocket.js","sourcesContent":["var noop = function(params) {}\nvar Server = require('socket.io');\nvar http = require('http')\nvar socket_config = {}\nvar io, sio = {\n    on: noop,\n    off: noop,\n    emit: noop,\n    use: noop\n  }\n\nfunction ioof(io){\n  return function (path) {\n    if (io){\n      io.of(path)\n      run()\n    }\n  }\n}\n\nfunction wspush(io) {\n  return function (name, msg) {\n    io.emit(name, msg);\n  }\n}\n\nfunction wsuse(io) {\n  return function(cb) {\n    if (io) return io.use(cb)\n  }\n}\n\nfunction wson() {  // cb is function and cb.length = 3 / cb({Json}, skt{SOCKET}, client{Json})\n  var scfg = socket_config;\n  return function(name, cb) {\n    if (typeof cb == 'function') scfg[name] = cb\n  }\n}\n\nfunction websocket(app){\n  var scfg = socket_config;\n  var _server_ = http.createServer(app.callback());\n  io = new Server(_server_);\n\n  sio = {\n    on: wson(),\n    of: ioof(io),\n    emit: wspush(io),\n    use: wsuse(io)\n  }\n\n  return _server_;\n}\n\nfunction mkon(socket) {\n  // const client = socket.handshake\n  Object.keys(socket_config).forEach( function(item) {\n    var cb = socket_config[item]\n    if (typeof cb == 'function') {\n      socket.on(item, function(data) {\n        cb(data, socket)\n      })\n    }\n  })\n\n  // var _keys = Object.keys(scfg)\n  // _keys.map(function (item, i) {\n  //   var _cb = mkmkon(scfg[item], socket)\n  //   socket.on(item, _cb)\n  // })\n}\n\n// function mkmkon(cb, _socket) {\n//   const client = _socket.handshake\n//   return function (data) {\n//     cb.call({ io: io }, data, _socket, client)\n//   }\n// }\n\nfunction run(){\n  if (io){\n    io.on('connection', function(socket){\n      mkon(socket);\n      // socket.on('first', function(data){\n      //   io.emit('first', {data: { user: 'world',message:'ni mei' }});\n      // })\n      socket.on('disconnect', function(){\n        console.log('user disconnect');\n      })\n    })\n  }\n}\n\nmodule.exports = {\n  init: websocket,\n  of: ioof(io),\n  run: run,\n  sio: sio\n}\n"]}