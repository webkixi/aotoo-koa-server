{"version":3,"sources":["fkpcore/modules/cache.js"],"names":["md5","require","LRU","module","exports","params","options","max","length","n","key","dispose","value","maxAge","_","merge","cache","setOptions","props","opts","has","isString","get","set","peek","del","ifid","callback","tmp","undefined","reset","forEach","rforEach","keys","values","itemCount","dump","load","prune"],"mappings":";;AAAA;;;AAGA,IAAIA,MAAMC,QAAQ,aAAR,CAAV;AACA,IAAIC,MAAMD,QAAQ,WAAR,CAAV;;AAEAE,OAAOC,OAAP,GAAiB,UAASC,MAAT,EAAiB;AACjC,KAAIC,UAAU;AACbC,OAAK,GADQ;AAEXC,UAAQ,gBAAUC,CAAV,EAAaC,GAAb,EAAkB;AAAE,UAAOD,IAAI,CAAJ,GAAQC,IAAIF,MAAnB;AAA2B,GAF5C;AAGXG,WAAS,iBAAUD,GAAV,EAAeE,KAAf,EAAsB,CAAG,CAHvB;AAIXC,UAAQ,KAAK,EAAL,GAAU,EAAV,GAAe;AAJZ,EAAd;;AAOAP,WAAUQ,EAAEC,KAAF,CAAQT,OAAR,EAAiBD,MAAjB,CAAV;AACA,KAAIW,QAAQd,IAAII,OAAJ,CAAZ;;AAEA,QAAO;AACNW,cAAY,oBAASC,KAAT,EAAgB;AAC3B,OAAMC,OAAOL,EAAEC,KAAF,CAAQT,OAAR,EAAiBY,KAAjB,CAAb;AACAF,WAAQd,IAAIiB,IAAJ,CAAR;AACA,GAJK;AAKNC,OAAK,aAAUV,GAAV,EAAe;AACnB,OAAII,EAAEO,QAAF,CAAWX,GAAX,CAAJ,EAAqB;AACpBA,UAAMV,IAAIU,GAAJ,CAAN;AACA;AACD,UAAOM,MAAMI,GAAN,CAAUV,GAAV,CAAP;AACA,GAVK;AAWNY,OAAK,aAAUZ,GAAV,EAAe;AACnB,OAAII,EAAEO,QAAF,CAAWX,GAAX,CAAJ,EAAqB;AACpBA,UAAMV,IAAIU,GAAJ,CAAN;AACA;AACD,UAAOM,MAAMM,GAAN,CAAUZ,GAAV,CAAP;AACA,GAhBK;AAiBNa,OAAK,aAAUb,GAAV,EAAeE,KAAf,EAAsBC,MAAtB,EAA8B;AAClC,OAAIC,EAAEO,QAAF,CAAWX,GAAX,CAAJ,EAAqB;AACpBA,UAAMV,IAAIU,GAAJ,CAAN;AACA;AACD,UAAOM,MAAMO,GAAN,CAAUb,GAAV,EAAeE,KAAf,EAAsBC,MAAtB,CAAP;AACA,GAtBK;AAuBNW,QAAM,cAAUd,GAAV,EAAe;AACpB,OAAII,EAAEO,QAAF,CAAWX,GAAX,CAAJ,EAAqB;AACpBA,UAAMV,IAAIU,GAAJ,CAAN;AACA;AACD,UAAOM,MAAMQ,IAAN,CAAWd,GAAX,CAAP;AACA,GA5BK;AA6BNe,OAAK,aAAUf,GAAV,EAAe;AACnB,OAAII,EAAEO,QAAF,CAAWX,GAAX,CAAJ,EAAqB;AACpBA,UAAMV,IAAIU,GAAJ,CAAN;AACA;AACD,UAAOM,MAAMS,GAAN,CAAUf,GAAV,CAAP;AACA,GAlCK;AAmCNgB,QAAM,cAAChB,GAAD,EAAMiB,QAAN,EAAmB;AACxB,OAAI,OAAOjB,GAAP,IAAc,QAAlB,EAA4B;AAC3B,QAAIkB,MAAMZ,MAAMI,GAAN,CAAUpB,IAAIU,GAAJ,CAAV,CAAV;AACA,WAAOkB,MAAMA,GAAN,GAAa,YAAW;AAC9B,YAAO,OAAOD,QAAP,IAAmB,UAAnB,GAAgCA,UAAhC,GAA6CE,SAApD;AACA,KAFkB,EAAnB;AAGA;AACD,GA1CK;AA2CNC,SAAOd,MAAMc,KA3CP;AA4CNC,WAASf,MAAMe,OA5CT;AA6CNC,YAAUhB,MAAMgB,QA7CV;AA8CNC,QAAMjB,MAAMiB,IA9CN;AA+CNC,UAAQlB,MAAMkB,MA/CR;AAgDN1B,UAAQQ,MAAMR,MAhDR;AAiDN2B,aAAWnB,MAAMmB,SAjDX;AAkDNC,QAAMpB,MAAMoB,IAlDN;AAmDNC,QAAMrB,MAAMqB,IAnDN;AAoDNC,SAAOtB,MAAMsB;AApDP,EAAP;AAsDA,CAjED","file":"../../../fkpcore/modules/cache.js","sourcesContent":["/*\n * lru cache\n*/\nvar md5 = require('blueimp-md5');\nvar LRU = require('lru-cache')\n\nmodule.exports = function(params) {\n\tlet options = {\n\t\tmax: 300\n\t\t, length: function (n, key) { return n * 2 + key.length }\n\t\t, dispose: function (key, value) { }\n\t\t, maxAge: 24 * 60 * 60 * 1000\n\t};\n\n\toptions = _.merge(options, params)\n\tvar cache = LRU(options);\n\n\treturn {\n\t\tsetOptions: function(props) {\n\t\t\tconst opts = _.merge(options, props)\n\t\t\tcache = LRU(opts);\n\t\t},\n\t\thas: function (key) {\n\t\t\tif (_.isString(key)) {\n\t\t\t\tkey = md5(key);\n\t\t\t}\n\t\t\treturn cache.has(key)\n\t\t},\n\t\tget: function (key) {\n\t\t\tif (_.isString(key)) {\n\t\t\t\tkey = md5(key);\n\t\t\t}\n\t\t\treturn cache.get(key)\n\t\t},\n\t\tset: function (key, value, maxAge) {\n\t\t\tif (_.isString(key)) {\n\t\t\t\tkey = md5(key);\n\t\t\t}\n\t\t\treturn cache.set(key, value, maxAge)\n\t\t},\n\t\tpeek: function (key) {\n\t\t\tif (_.isString(key)) {\n\t\t\t\tkey = md5(key);\n\t\t\t}\n\t\t\treturn cache.peek(key)\n\t\t},\n\t\tdel: function (key) {\n\t\t\tif (_.isString(key)) {\n\t\t\t\tkey = md5(key);\n\t\t\t}\n\t\t\treturn cache.del(key)\n\t\t},\n\t\tifid: (key, callback) => {\n\t\t\tif (typeof key == 'string') {\n\t\t\t\tvar tmp = cache.has(md5(key))\n\t\t\t\treturn tmp ? tmp : (function() {\n\t\t\t\t\treturn typeof callback == 'function' ? callback() : undefined\n\t\t\t\t})()\n\t\t\t}\n\t\t},\n\t\treset: cache.reset,\n\t\tforEach: cache.forEach,\n\t\trforEach: cache.rforEach,\n\t\tkeys: cache.keys,\n\t\tvalues: cache.values,\n\t\tlength: cache.length,\n\t\titemCount: cache.itemCount,\n\t\tdump: cache.dump,\n\t\tload: cache.load,\n\t\tprune: cache.prune\n\t}\n}"]}