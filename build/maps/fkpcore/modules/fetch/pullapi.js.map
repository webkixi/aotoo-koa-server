{"version":3,"sources":["fkpcore/modules/fetch/pullapi.js"],"names":["DEBUG","debug","getMyApi","api","apilist","apiAry","split","len","length","select","_","trim","nAry","splice","nApi","join","nCollect","module","exports","_parseClientForm","param","method","url","undefined","fetchRemote","message","indexOf","_redirect","ajaxtype","list","query","toLowerCase","json","get","_api","_param","error","test","_stat_","_get","_data","data","post","form","_post"],"mappings":"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","file":"../../../../fkpcore/modules/fetch/pullapi.js","sourcesContent":["import path from 'path'\nimport {stringify} from 'querystring'\nconst DEBUG = debug('fkp:modules:pullapi')\n\nfunction getMyApi(api, apilist){\n  const apiAry = api.split(':')\n  let len = apiAry.length\n  const select = apilist[ _.trim(apiAry[0]) ]\n  if (len > 1 && select) {\n    const nAry = apiAry.splice(1)\n    const nApi = nAry.join(':')\n    const nCollect = select\n    return getMyApi(nApi, nCollect)\n  } else {\n    return select\n  }\n}\n\nmodule.exports = function(){\n  return {\n    _parseClientForm: function(api, param={}, method='get'){\n      let url = undefined\n      this.fetchRemote = false\n      // if(objtypeof(param)!=='object') return [null, { message: 'pullApiData === 请指定正确的参数'}]\n      if(!api) return [null, { message: 'pullApiData === 请指定正确的参数'}]\n      if(typeof param !== 'object') param = {}\n\n      /**\n       前端通过api.requ('http://www.xxx.com/api')获取外部远程数据\n       http://www.xxx.com/api部分会被存在parma._redirect的key值中\n       api会自动转成 'redirect'\n       ajax的方法(post/get)，通过param参数传入，key值名为ajaxtype，这个等同于jq的名字\n      */\n      if (api.indexOf('redirect')===0){\n        url = param._redirect;\n        delete param._redirect\n        if (param.ajaxtype){\n          method = param.ajaxtype\n          delete param.ajaxtype\n        }\n        if (param && param.method) {\n          method = param.method\n          delete param.method\n        }\n        let len = Object.keys(param)\n        if (len.length===0) param = {}\n      }\n\n      else if (api.indexOf('http')===0) {\n        this.fetchRemote = true\n        method = 'get'\n        url = api\n      }\n\n      else {\n        // url = this.apilist.list[api]\n        url = getMyApi(api, this.apilist.list)\n        if( !url ) return [null, null]\n      }\n\n      let query=undefined\n      method = method.toLowerCase();\n      if (method==='get')  query = {json: param}\n      if (method==='post') query = {json: param}\n      return [url, query]\n    },\n\n    get: async function(api, param){\n      DEBUG('get api %s', api)\n      let [_api, _param] = this._parseClientForm(api, param, 'get')\n      if (!_api) return {error: \"60001\", message: \"指定api不存在\"}\n      if (_param && _param.json && _param.json.test && _param.json.test == '123') delete _param.json.test\n      if (_param && _param.json && _param.json._stat_ ) delete _param.json._stat_\n      DEBUG('get param %O', _param)\n      let _data = await this._get(_api, _param)\n      return {data: _data}\n    },\n\n    post: async function(api, param){\n      DEBUG('post api %s', api)\n      let [_api, _param] = this._parseClientForm(api, param, 'post')\n      if (!_api) return {error: \"60001\", message: \"指定api不存在\"}\n      if (_param && _param.form && _param.form.test && _param.form.test == '123') delete _param.form.test\n      DEBUG('post param %O', _param)\n      let _data = await this._post(_api, _param)\n      return {data: _data}\n    }\n  }\n}\n"]}