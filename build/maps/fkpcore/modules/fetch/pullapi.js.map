{"version":3,"sources":["fkpcore/modules/fetch/pullapi.js"],"names":["module","exports","_parseClientForm","api","param","method","url","undefined","fetchRemote","message","indexOf","_redirect","ajaxtype","len","Object","keys","length","apilist","list","query","toLowerCase","json","get","debug","_api","_param","Errors","test","_stat_","_get","_data","data","post","form","_post"],"mappings":"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","file":"../../../../fkpcore/modules/fetch/pullapi.js","sourcesContent":["import path from 'path'\nimport {stringify} from 'querystring'\n\nmodule.exports = function(){\n  return {\n    _parseClientForm: function(api, param={}, method='get'){\n      let url = undefined\n      this.fetchRemote = false\n      // if(objtypeof(param)!=='object') return [null, { message: 'pullApiData === 请指定正确的参数'}]\n      if(!api) return [null, { message: 'pullApiData === 请指定正确的参数'}]\n      if(typeof param !== 'object') param = {}\n\n      /**\n       前端通过api.requ('http://www.xxx.com/api')获取外部远程数据\n       http://www.xxx.com/api部分会被存在parma._redirect的key值中\n       api会自动转成 'redirect'\n       ajax的方法(post/get)，通过param参数传入，key值名为ajaxtype，这个等同于jq的名字\n      */\n      if (api.indexOf('redirect')===0){\n        url = param._redirect;\n        delete param._redirect\n        if (param.ajaxtype){\n          method = param.ajaxtype\n          delete param.ajaxtype\n        }\n        if (param && param.method) {\n          method = param.method\n          delete param.method\n        }\n        let len = Object.keys(param)\n        if (len.length===0) param = {}\n      }\n\n      else if (api.indexOf('http')===0) {\n        this.fetchRemote = true\n        method = 'get'\n        url = api\n      }\n\n      else {\n        url = this.apilist.list[api]\n        if( !url ) return [null, null]\n      }\n\n      let query=undefined\n      method = method.toLowerCase();\n      if (method==='get')  query = {json: param}\n      if (method==='post') query = {json: param}\n      return [url, query]\n    },\n\n    get: async function(api, param){\n      debug('get:'+ api)\n      let [_api, _param] = this._parseClientForm(api, param, 'get')\n      if (!_api) return Errors['60001']\n      if (_param && _param.json && _param.json.test && _param.json.test == '123') delete _param.json.test\n      if (_param && _param.json && _param.json._stat_ ) delete _param.json._stat_\n      // if (CONFIG.apis.mock) {\n      //   return await this.mock(api, _param)\n      // } else {\n      //   let _data = await this._get(_api, _param)\n      //   return {data: _data}\n      // }\n      let _data = await this._get(_api, _param)\n      return {data: _data}\n    },\n\n    post: async function(api, param){\n      debug('post:'+ api);\n      let [_api, _param] = this._parseClientForm(api, param, 'post')\n      if (!_api) return Errors['60001']\n      if (_param && _param.form && _param.form.test && _param.form.test == '123') delete _param.form.test\n      // if (CONFIG.apis.mock) {\n      //   return await this.mock(api, _param)\n      // } else {\n      //   let _data = await this._post(_api, _param)\n      //   return {data: _data}\n      // }\n      let _data = await this._post(_api, _param)\n      return {data: _data}\n    }\n  }\n}\n"]}