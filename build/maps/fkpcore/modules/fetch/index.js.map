{"version":3,"sources":["fkpcore/modules/fetch/index.js"],"names":["DEBUG","debug","AKSHOOKS","SAX","inherits","Super","protos","staticProtos","child","hasOwnProperty","constructor","apply","arguments","_","merge","__super__","prototype","_request","opts","default_options","headers","timeout","apis","apilist","options","fetchRemote","init","ctx","setOpts","api","method","json","fttype","requestOptions","emit","__request","setOptions","params","_get","cb","call","_opts","_api","_q","res","rej","get","err","rep","body","statusCode","_post","post","pullapi","require","requ","module","exports"],"mappings":"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","file":"../../../../fkpcore/modules/fetch/index.js","sourcesContent":["import path from 'path'\nimport request from 'request'\nimport {stringify} from 'querystring'\nconst DEBUG = debug('fkp:modules:fetch')\nconst AKSHOOKS = SAX('AOTOO-KOA-SERVER')\n\nfunction inherits( Super, protos, staticProtos ) {\n  var child;\n  if ( typeof protos === 'function' ) {\n    child = protos;\n    protos = null;\n  } else if ( protos && protos.hasOwnProperty('constructor') ) {\n    child = protos.constructor;\n  } else {\n    child = function() {\n      return Super.apply( this, arguments );\n    }\n  }\n  _.merge( child, Super, staticProtos || {} )\n  child.__super__ = Super.prototype\n  child.prototype = Super.prototype\n  protos && _.merge( child.prototype, protos )\n  return child;\n}\n\nlet _request = function(opts){\n  var default_options = {\n    headers: { },\n    timeout: 10000\n  }\n  if (opts.apis) {\n    this.apilist = opts.apis\n    delete opts.apis\n  }\n  this.options = _.merge(default_options, opts)\n  this.fetchRemote = false\n}\n_request.prototype = {\n  init: function(ctx){\n    this.ctx = ctx || {}\n  }\n}\n\nfunction setOpts(api, options, method) {\n  let opts = {\n    json: {},\n  }\n  // if (options && _.isPlainObject(options)) opts = _.merge(opts, options)\n  opts = _.merge(opts, this.options, options)\n  if (opts.json && opts.json.headers) {\n    opts.headers = opts.json.headers\n    delete opts.json.headers\n    // opts.headers = _headers\n  }\n  if (opts.fttype) {\n    delete opts.fttype;\n  }\n  this.api = api\n  this.requestOptions = AKSHOOKS.emit('apiFetchOptions', { api, options: opts }) || opts || {}\n}\n\nlet __request = inherits(_request, {\n  setOptions: function(params) {\n    if (params.apis) {\n      this.apilist = params.apis\n      delete params.apis\n    }\n    this.options = _.merge(this.options, params)\n  },\n\n  _get: function(api, options, cb){\n    setOpts.call(this, api, options, 'get')\n    let _opts = this.requestOptions\n    let _api = this.api\n    DEBUG('_get api %s', api)\n    DEBUG('_get options: %O', _opts);\n    if (_opts && _opts.json){\n      let _q = stringify(_opts.json)\n      api = api + '?' + _q;\n      delete _opts.json\n    }\n    return new Promise( (res, rej) => {\n      request.get(api, _opts, (err, rep, body)=>{\n        if(err) { return rej(\"async search: no respons data\")}\n        if (rep.statusCode == 200){\n          DEBUG('_get response body %O', body)\n          return res(body)\n        }\n      })\n    })\n  },\n\n  _post: function(api, options, cb){\n    setOpts.call(this, api, options, 'post')\n    let _opts = this.requestOptions\n    let _api = this.api\n    _opts.headers['Content-type'] = 'application/json; charset=utf-8'\n    DEBUG('_post api %s', api)\n    DEBUG('_post options: %O', _opts);\n    return new Promise( (res, rej) => {\n      request.post(_api, _opts, (err, rep, body)=>{\n        if(err) {return rej(\"async search: no respons data\")}\n        if (rep.statusCode == 200){\n          DEBUG('_get response body %O', body)\n          return res(body)\n        }\n      })\n    })\n  }\n})\n\nlet pullapi = inherits(__request, require('./pullapi')())\nlet requ = inherits(pullapi, {})\n// let pullapi = inherits(__request, require('./pullapi')())\n// let mocks = inherits(pullapi, require('./mockapi')())\n// let requ = inherits(mocks, {})\n\nmodule.exports = function(opts){\n  return new requ(opts)\n}\n"]}