{"version":3,"sources":["fkpcore/modules/fetch/index.js"],"names":["DEBUG","debug","inherits","Super","protos","staticProtos","child","hasOwnProperty","constructor","apply","arguments","_","merge","__super__","prototype","_request","opts","apilist","apis","fetchRemote","init","ctx","__request","setOpts","api","options","method","headers","json","timeout","isPlainObject","_headers","fttype","requestOptions","_get","cb","_opts","_api","_q","res","rej","get","err","rep","body","statusCode","_post","post","pullapi","require","requ","module","exports"],"mappings":"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","file":"../../../../fkpcore/modules/fetch/index.js","sourcesContent":["import path from 'path'\nimport request from 'request'\nimport {stringify} from 'querystring'\nconst DEBUG = debug('fkp:modules:fetch')\n\nfunction inherits( Super, protos, staticProtos ) {\n  var child;\n  if ( typeof protos === 'function' ) {\n    child = protos;\n    protos = null;\n  } else if ( protos && protos.hasOwnProperty('constructor') ) {\n    child = protos.constructor;\n  } else {\n    child = function() {\n      return Super.apply( this, arguments );\n    }\n  }\n  _.merge( child, Super, staticProtos || {} )\n  child.__super__ = Super.prototype\n  child.prototype = Super.prototype\n  protos && _.merge( child.prototype, protos )\n  return child;\n}\n\nlet _request = function(opts){\n  this.opts = opts\n  this.apilist = this.opts.apis\n  this.fetchRemote = false\n}\n_request.prototype = {\n  init: function(ctx){\n    this.ctx = ctx || {}\n  }\n}\n\nlet __request = inherits(_request, {\n\n  setOpts: function(api, options, method){\n    let opts = {\n      headers: {},\n      json: {},\n      timeout: 10000\n    }\n    if (options && _.isPlainObject(options)) opts = _.merge(opts, options)\n    if (opts.json && opts.json.headers) {\n      const _headers = _.merge({}, opts.json.headers)\n      delete opts.json.headers\n      opts.headers = _headers\n    }\n    if (opts.fttype){\n      delete opts.fttype;\n    }\n    this.api = api\n    this.requestOptions = opts\n  },\n\n  _get: function(api, options, cb){\n    this.setOpts(api, options, 'get')\n    let _opts = this.requestOptions\n    let _api = this.api\n    DEBUG('_get api %s', api)\n    DEBUG('_get options: %O', _opts);\n    if (_opts && _opts.json){\n      let _q = stringify(_opts.json)\n      api = api + '?' + _q;\n      delete _opts.json\n    }\n    return new Promise( (res, rej) => {\n      request.get(api, _opts, (err, rep, body)=>{\n        if(err) { return rej(\"async search: no respons data\")}\n        if (rep.statusCode == 200){\n          DEBUG('_get response body %O', body)\n          return res(body)\n        }\n      })\n    })\n  },\n\n  _post: function(api, options, cb){\n    this.setOpts(api, options, 'post')\n    let _opts = this.requestOptions\n    let _api = this.api\n    _opts.headers['Content-type'] = 'application/json; charset=utf-8'\n    DEBUG('_post api %s', api)\n    DEBUG('_post options: %O', _opts);\n    return new Promise( (res, rej) => {\n      request.post(_api, _opts, (err, rep, body)=>{\n        if(err) {return rej(\"async search: no respons data\")}\n        if (rep.statusCode == 200){\n          DEBUG('_get response body %O', body)\n          return res(body)\n        }\n      })\n    })\n  }\n})\n\nlet pullapi = inherits(__request, require('./pullapi')())\nlet requ = inherits(pullapi, {})\n// let pullapi = inherits(__request, require('./pullapi')())\n// let mocks = inherits(pullapi, require('./mockapi')())\n// let requ = inherits(mocks, {})\n\nmodule.exports = function(opts){\n  return new requ(opts)\n}\n"]}