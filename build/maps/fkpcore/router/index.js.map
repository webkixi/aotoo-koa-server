{"version":3,"sources":["fkpcore/router/index.js"],"names":["app","prefix","options","controlPages","_controlPages","DEBUG","router","Router","_","isPlainObject","customControl","map","item","key","includes","Array","isArray","forEach","rt","forBetter","routeParam","get","_path","post","use","routes","allowedMethods","init","ctx","_mapper","ctrlPages","isRender","filterRendeFile","params","url","route","makeRoute","fkproute","routerPrefix","opts","AKSHOOKS","append","runtime","pageData","staticMapper","distribute","dealwithRoute","routerInstance","controler","pdata","renderPage","isString","indexOf","replace","passAccess","xData","undefined","controlFile","Path","sep","getctrlData","businessPagesPath","hitedControlFile","join","controlIndexFile","controlCatFile","cat","item_file","push","paramsCatFile","xRoute","apilist","Fetch","list","nomatch","isAjax","fkp","_pageData","_names","_filename","resolve","__dirname","existsControlFun","controlFun","controlConfig","call","control","Error","fs","existsSync","controlModule","require","getData","data","preRender","emit","method","getStat","local","query","_stat_","body","console","log","render","err","error","status","hasOn","redirect","debug","Promise","glob","Url","md5","SAX","default","promisifyAll","ignoreStacic","getObjType","object","Object","prototype","toString","match","toLowerCase","pms","decodeURIComponent","rjson","parse","rtn","ext","exts","tempExts","noPassCat","getCtrlFiles","dir","controlFiles","stat","statSync","isDirectory","_partten","sync","obj","xxx","test","name","businessPages","mkdirSync","controlPagePath","_id","Cache","ifid","__cfile","set","stack","_url","indexRoot","index","_ext","extname","ctxurl","slice","title","id","gtpy","substring","lastIndexOf","length","path_join","jspath","src","charAt","mapper","Aotoo","inject","public","js","csspath","css","tmpletStatic","type","jspagesrc","csspagesrc","commonjs","common","commoncss","pagejs","pagecss","pagedata","_route","next","bind","mydata","myentry","entry","myroute","viewsRoot","state","absOriRoute","viewsFiles","views","getRoute","pages","module","exports"],"mappings":"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","file":"../../../fkpcore/router/index.js","sourcesContent":["/**\n * Module dependencies.\n */\nconst DEBUG = debug('fkp:router')\nlet fs = require('fs');\nconst Promise = require('bluebird')\nconst glob = require('glob')\nconst Path = require('path')\nconst Url = require('url')\nconst Router = require('koa-router')\nconst md5 = require('blueimp-md5')\nconst AKSHOOKS = SAX('AOTOO-KOA-SERVER')\nconst control = require('./control').default\nfs = Promise.promisifyAll(fs)\n\n// const businessPagesPath = '../../pages'\nlet businessPagesPath = ''\nconst ignoreStacic = ['css', 'js', 'images', 'img']\nconst routeParam = [\n  '/',\n  '/:cat',\n  '/:cat/:title',\n  '/:cat/:title/:id'\n]\n\nfunction getObjType(object) {\n  return Object.prototype.toString.call(object).match(/^\\[object\\s(.*)\\]$/)[1].toLowerCase();\n};\n\n/**\n * 过滤渲染文件\n * {param1} {json}   this.params\n * {param2} {json}   json of parse this.path\n * return   {boleean}\n**/\nfunction filterRendeFile(pms, url) {\n  url=url.replace(/\\?\\S*$/,'') // 避免?key=value参数影响ext判断\n\n  url=decodeURIComponent(url)\n  \n  let rjson = Path.parse(url)\n  let rtn = false;\n  let ext = rjson.ext;\n  let cat = pms.cat;\n\n  let exts = ['.css', '.js', '.swf', '.jpg', '.jpeg', '.png', '.bmp', '.ico'];\n  let tempExts = ['.html', '.shtml'];\n  let noPassCat = ['css', 'js', 'img', 'imgs', 'image', 'images'];\n\n  if (!ext) rtn = true;\n\n  return !ext || tempExts.includes(ext) || noPassCat.includes(cat)\n\n  // if (_.indexOf(tempExts, ext) > -1) rtn = true;\n  // if (_.indexOf(noPassCat, cat) > -1) rtn = false;\n\n  // return rtn;\n}\n\n/**\n * \n * @param {String} dir 遍历的目标目录\n * @param {String} rootpath 根目录的绝对路径\n */\n// async function getCtrlFiles(dir, rootpath) {\n//   const __myControlFiles = []\n//   const dirData = await fs.readdirAsync(dir)\n//   dirData.map(async (file) => {\n//     const _path = Path.join(dir, file)\n//     const stat = fs.statSync(_path)\n//     if (stat) {\n//       if (stat.isDirectory()) {\n//         __myControlFiles.concat(await getCtrlFiles(_path, rootpath))\n//       } else {\n//         __myControlFiles.push(_path.replace(rootpath, ''))\n//       }\n//     }\n//   })\n//   return __myControlFiles\n// }\n\nfunction getCtrlFiles(dir, opts = {}) {\n  var controlFiles = []\n  if (!fs.existsSync(dir)) return;\n  const stat = fs.statSync(dir)\n  if (!stat.isDirectory()) return\n\n  const _partten = /^[_\\.](\\w)+/;   // ?? 不兼容windows\n  glob.sync(dir + '/**/*').forEach(function (item) {\n    var obj = Path.parse(item)\n    const xxx = _partten.test(obj.name)\n    if (!xxx) {\n      if (obj.ext) {\n        controlFiles.push(item.replace(dir, ''))\n      }\n    }\n  })\n  return controlFiles\n};\n\n// 预读取pages目录下的所有文件路径，并保存\nfunction controlPages() {\n  // const businessPages = Path.join(__dirname, businessPagesPath)\n  const businessPages = businessPagesPath\n\n  if (!fs.existsSync(businessPages)) {\n    fs.mkdirSync(businessPages, '0777')\n  }\n\n  DEBUG('businessPages %s', businessPages)\n  const controlPagePath = businessPages\n  const _id = controlPagePath\n\n  try {\n    if (fs.existsSync(controlPagePath)) {\n      return Cache.ifid(_id, async () => {\n        const __cfile = await getCtrlFiles(controlPagePath, controlPagePath); Cache.set(_id, __cfile)\n        return __cfile\n      })\n    } else {\n      throw new Error('控制层目录不存在')\n    }\n  } catch (err) {\n    console.error(err.stack);\n  }\n\n  // let ctrlFiles = []\n  // return Cache.ifid(_id, () => new Promise((res, rej) => {\n  //   return function getCtrlFiles(dir) {\n  //     fs.readdir(dir, (err, data) => {\n  //       if (err) throw err\n  //       data.map(file => {\n  //         const _path = Path.join(dir, file)\n  //         const stat = fs.statSync(_path)\n  //         if (stat && stat.isDirectory()) return getCtrlFiles(_path)\n  //         const okPath = _path.replace(controlPagePath, '')\n  //         ctrlFiles.push(okPath)\n  //         // ctrlFiles.push(Path.join(okPath))\n  //       }) // end map\n  //       Cache.set(_id, ctrlFiles)\n  //       res(ctrlFiles)\n  //     })\n  //   }(controlPagePath)\n  // })\n  // )\n}\n\nfunction makeRoute(ctx, prefix) {\n  let params = ctx.params\n  let _url = ctx.url\n  const fkp = ctx.fkp\n  const indexRoot = fkp.index\n  ctx.local = Url.parse(ctx.url, true)\n\n  let _ext = Path.extname(ctx.url)\n  let ctxurl = ctx.url.slice(1).replace(_ext, '') || ''\n\n  if (_url.indexOf('?') > -1) {\n    _url = _url.slice(0, _url.indexOf('?'))\n    ctxurl = ctxurl.slice(0, ctxurl.indexOf('?'))\n  }\n  let rjson = Path.parse(_url)\n  let route = false\n  let cat = params.cat || '', title = params.title || '', id = params.id || '';\n  let gtpy = getObjType;\n\n  if (id) {\n    gtpy(id) === 'number'\n      ? route = title\n        ? cat + '/' + title\n        : cat\n      : route = cat + '/' + title + '/' + id\n  }\n\n  else if (title) {\n    title = title.replace(rjson.ext, '');\n    route = gtpy(title) === 'number' ? cat : cat + '/' + title\n  }\n\n  else if (cat) {\n    cat = cat.replace(rjson.ext, '');\n    route = gtpy(cat) === 'number' ? indexRoot || 'index' : cat\n  }\n\n  else {\n    route = indexRoot || 'index'\n  }\n  if (ctxurl && route !== ctxurl) route = ctxurl\n  if (prefix) route = prefix.indexOf('/') == 0 ? prefix.substring(1) : prefix\n  if (route.lastIndexOf('/') == (route.length - 1)) {\n    route = route.substring(0, route.length - 1)\n  }\n  return route\n}\n\nfunction path_join(jspath, src) {\n  if (jspath.indexOf('http') == 0 || jspath.indexOf('//') == 0) {\n    if (jspath.charAt(jspath.length - 1) == '/') {\n      jspath = jspath.substring(0, jspath.length - 1)\n    }\n    if (src.charAt(0) == '/') {\n      return jspath + src\n    } else {\n      return jspath + '/' + src\n    }\n  } else {\n    return Path.join(jspath, src);\n  }\n}\n\nfunction staticMapper(ctx, mapper, route, routerPrefix) {\n  const jspath = Aotoo.inject.public.js\n  const csspath = Aotoo.inject.public.css\n  let tmpletStatic = (src, type) => {\n    if (type == 'js') {\n      const jspagesrc = path_join(jspath, src)\n      return '<script type=\"text/javascript\" src=\"' + jspagesrc + '\" ></script>'\n    }\n    if (type == 'css') {\n      const csspagesrc = path_join(csspath, src)\n      return '<link rel=\"stylesheet\" href=\"' + csspagesrc + '\" />'\n    }\n  }\n\n  if (_.isString(routerPrefix) && routerPrefix.indexOf('/') == 0) routerPrefix = routerPrefix.replace('/', '')\n  if (!mapper) return false\n  let pageData = {\n    //静态资源\n    commonjs: tmpletStatic((mapper.js.common || 'common.js'), 'js'),   //公共css\n    commoncss: tmpletStatic((mapper.css.common || 'common.css'), 'css'), //公共js\n    pagejs: '',\n    pagecss: '',\n    pagedata: {}\n  }\n  //静态资源初始化\n  if (route.indexOf('/') == 0) route = route.substring(1)\n  if (route.lastIndexOf('/') == (route.length - 1)) route = route.substring(0, route.length - 1)\n  if (mapper.css[route]) pageData.pagecss = tmpletStatic(mapper.css[route], 'css')\n  if (mapper.js[route]) pageData.pagejs = tmpletStatic(mapper.js[route], 'js')\n\n  let _route = route\n  if (routerPrefix) {\n    _route = routerPrefix\n    if (mapper.css[_route]) pageData.pagecss = tmpletStatic(mapper.css[_route], 'css')\n    if (mapper.js[_route]) pageData.pagejs = tmpletStatic(mapper.js[_route], 'js')\n  }\n\n  return pageData\n}\n\n/**\n * 路由分配\n * {param1} koa implement\n * {param2} map of static file\n * return rende pages\n**/\nasync function init(app, prefix, options) {\n  let _controlPages = await controlPages()\n  DEBUG('control pages === %O', _controlPages)\n  const router = prefix ? new Router({ prefix: prefix }) : new Router()\n  if (options && _.isPlainObject(options)) {\n    let customControl\n    if (options.customControl) {\n      customControl = options.customControl\n    }\n    _.map(options, (item, key) => {\n      if (_.includes(['get', 'post', 'put', 'del'], key)) {\n        if (typeof item == 'string') item = [item]\n        if (!Array.isArray(item)) return\n        item.forEach(rt => {\n          if (key != 'get') {\n            if (rt != '/') {\n              router[key](rt, router:: (customControl || forBetter(router, _controlPages)))\n            }\n          } else {\n            router[key](rt, router:: (customControl || forBetter(router, _controlPages)))\n          }\n        })\n      } else {\n        routeParam.forEach(_path => {\n          router.get(_path, router:: (customControl || forBetter(router, _controlPages)))\n          router.post(_path, router:: (customControl || forBetter(router, _controlPages)))\n        })\n      }\n    })\n  } else {\n    routeParam.forEach(item => {\n      router.get(item, forBetter(router, _controlPages))\n      if (item != '/') {\n        router.post(item, forBetter(router, _controlPages))\n      }\n    })\n  }\n  app.use(router.routes())\n  app.use(router.allowedMethods())\n}\n\nfunction forBetter(router, ctrlPages) {\n  return async function (ctx, next) {\n    try {\n      if (ignoreStacic.indexOf(ctx.params.cat) == -1) {\n        return await dealwithRoute.call(this, ctx, ctx.fkp.staticMapper, ctrlPages)\n      }\n    } catch (e) {\n      console.log(e.stack)\n    }\n  }.bind(router)\n}\n\n/**\n * 路由配置\n * {param1} koa implement\n * {param2} map of static file\n * return rende pages\n**/\nasync function dealwithRoute(ctx, _mapper, ctrlPages) {\n  try {\n    let isRender = filterRendeFile(ctx.params, ctx.url)\n    let route = isRender ? makeRoute(ctx) : false\n    if (!route) throw 'route配置不正确'\n    ctx.fkproute = route\n    let routerPrefix = this.opts.prefix\n    ctx.routerPrefix = routerPrefix\n    AKSHOOKS.append({\n      route: {\n        runtime: {\n          route: route,\n          prefix: routerPrefix\n        }\n      }\n    })\n    DEBUG('dealwithRoute route = %s', route)\n    DEBUG('dealwithRoute routerPrefix = %s', routerPrefix)\n\n    let pageData = staticMapper(ctx, _mapper, route, routerPrefix)\n    if (!pageData) throw 'mapper数据不正确'\n    return ctx:: distribute(route, pageData, ctrlPages, this)\n  } catch (e) {\n    DEBUG('dealwithRoute error = %O', e)\n    // console.log(e);\n  }\n}\n\n// 分发路由\nasync function distribute(route, pageData, ctrlPages, routerInstance) {\n  try{\n    let [pdata, rt] = await controler(this, route, pageData, ctrlPages, routerInstance)\n    return await renderPage(this, rt, pdata)\n  }catch(e){\n    DEBUG('dealwithRoute error = %O', e)\n    return await renderPage(this, null, null)\n    // 渲染模板出错重定向至404页面\n    // return await this.render('404')\n  }\n}\n\n\nasync function controler(ctx, route, pageData, ctrlPages, routerInstance) {\n  let routerPrefix = routerInstance.opts.prefix\n  if (_.isString(routerPrefix) && routerPrefix.indexOf('/') == 0) {\n    routerPrefix = routerPrefix.replace('/', '')\n  }\n\n  try {\n    let passAccess = false\n    let xData = undefined\n    // 根据route匹配到control文件+三层路由\n    const controlFile = Path.sep + route + '.js'\n    if (ctrlPages.indexOf(controlFile) > -1) {\n      xData = await getctrlData([businessPagesPath + '/' + route], route, ctx, pageData, routerInstance)\n    }\n    // 根据prefix匹配到control文件+三层路由\n    else if (routerPrefix) {\n      route = routerPrefix\n      // let prefixRootFile = Path.join(businessPagesPath, routerPrefix)\n      // let prefixIndexFile = Path.join(businessPagesPath, routerPrefix, '/index')\n      // let prefixCatFile = Path.join(businessPagesPath, routerPrefix, ctx.params.cat || '')\n      // xData = await getctrlData([prefixCatFile, prefixIndexFile, prefixRootFile], route, ctx, pageData, routerInstance)\n\n      const hitedControlFile = []\n      const controlFile = Path.join(Path.sep, routerPrefix)\n      const controlIndexFile = Path.join(Path.sep, routerPrefix, 'index')\n      const controlCatFile = Path.join(Path.sep, routerPrefix, (ctx.params.cat||''))\n      Array.forEach([controlFile, controlIndexFile, controlCatFile], item => {\n        const item_file = item + '.js'\n        if (ctrlPages.indexOf(item_file) > -1) {\n          hitedControlFile.push(Path.join(businessPagesPath, item))\n        }\n      })\n      \n      xData = await getctrlData(hitedControlFile, route, ctx, pageData, routerInstance)\n    }\n    // pages根目录+三层路由\n    else {\n      if (ctx.params.cat) {\n        let paramsCatFile = Path.join(businessPagesPath, ctx.params.cat)\n        const xRoute = ctx.params.cat\n        xData = await getctrlData([paramsCatFile], xRoute, ctx, pageData, routerInstance)\n      }\n    }\n    // 根据 Fetch.apilist 匹配到api接口，从远程借口拿去数据\n    if (!xData) {\n      let apilist = Fetch.apilist\n      if (apilist.list[route] || route === 'redirect') {\n        passAccess = true\n        xData = await getctrlData(['./passaccesscontrol'], route, ctx, pageData, routerInstance)\n      } else {\n        xData = { nomatch: true }\n      }\n    }\n    const isAjax = ctx.fkp.isAjax()\n    if (passAccess || isAjax) pageData = xData\n    return [pageData, route]\n  } catch (e) {\n    DEBUG('controler error = %O', e)\n    // console.log(e.stack);\n  }\n}\n\nvar existsControlFun = {}\n\n// match的control文件，并返回数据\nasync function getctrlData(_path, route, ctx, _pageData, routerInstance) {\n  // try {\n    let _names = []\n    if (Array.isArray(_path)) {\n      for (let _filename of _path) {\n        _filename = Path.resolve(__dirname, _filename + '.js')\n        _names.push(_filename)\n      }\n    }\n\n    if (existsControlFun[_names[0]]) {\n      const controlFun = existsControlFun[_names[0]]\n      const controlConfig = controlFun ? controlFun.call(ctx, _pageData) : undefined\n      if (controlConfig) {\n        return await control(route, ctx, _pageData, routerInstance, controlConfig)\n      } else {\n        throw new Error('控制器文件不符合规范')\n      }\n    }\n\n    if (fs.existsSync(_names[0])) {\n      const controlModule = require(_names[0])\n      if (controlModule) {\n        const controlFun = typeof controlModule == 'function' \n        ? controlModule \n        : controlModule.getData && controlModule.getData && typeof controlModule.getData == 'function' \n        ? controlModule.getData \n        : undefined\n\n        existsControlFun[_names[0]] = controlFun\n        const controlConfig = controlFun ? controlFun.call(ctx, _pageData) : undefined\n        if (controlConfig) {\n          _pageData = await control(route, ctx, _pageData, routerInstance, controlConfig)\n        } else {\n          throw new Error('控制器文件不符合规范')\n        }\n      } else {\n        _pageData = undefined\n      }\n    } else {\n      _pageData = undefined\n    }\n    return _pageData\n  // } catch (e) {\n  //   console.log(e);\n  //   DEBUG('getctrlData error = %O', e)\n  //   // return { nomatch: true }\n  // } finally {\n  //   _pageData = undefined\n  //   return _pageData\n  // }\n}\n\nfunction preRender(rt, ctx) {\n  const mydata = AKSHOOKS.get()\n  const myentry = mydata.entry\n  const myroute = mydata.route.runtime.route\n  const prefix = mydata.route.runtime.prefix\n  const viewsRoot = myentry.state.viewsRoot\n  const absOriRoute = Path.join(viewsRoot, myroute + '.html')\n\n  const viewsFiles = myentry.state.views\n  if (viewsFiles.indexOf(absOriRoute) > -1) {\n    if (rt != myroute) return myroute\n    return rt\n  } else {\n    if (prefix) {\n      return rt\n    } else {\n      throw new Error(`模板文件不存在，${absOriRoute}`)\n    }\n  }\n}\n\n// dealwith the data from controlPage\nasync function renderPage(ctx, route, data, isAjax) {\n  try {\n    DEBUG('renderPage pageData = %O', data)\n    DEBUG('renderPage route = %s', route)\n    if (route) {\n      route = preRender(route, ctx)\n      data = AKSHOOKS.emit('pageWillRender', data) || data\n      switch (ctx.method) {\n        case 'GET':\n          let getStat = ctx.local.query._stat_\n          if ((getStat && getStat === 'DATA') || isAjax) return ctx.body = data\n          if (data && data.nomatch) {\n            console.log('你访问的页面/api不存在');\n          }\n          return await ctx.render(route, data)\n        case 'POST':\n          ctx.body = data\n      }\n    } else {\n      throw new Error('模板文件不存在')\n    }\n  } catch (e) {\n    AKSHOOKS.emit('pageRenderError', { err: e, isAjax, ctx })\n    if (isAjax) {\n      ctx.body = {\n        error: 'node - 找不到相关信息'\n      }\n    } else {\n      ctx.status = 404\n      if (route == '404') {\n        ctx.body = '您访问的页面不存在!'\n      } else {\n        if (AKSHOOKS.hasOn('404')) {\n          return await AKSHOOKS.emit('404', ctx)\n        }\n        return await ctx.redirect('/404')\n      }\n      // return await ctx.render('404')\n    }\n  }\n}\n\ninit.makeRoute = makeRoute\ninit.getRoute = makeRoute\ninit.staticMapper = staticMapper\ninit.renderPage = renderPage\ninit.pages = function (_path) {\n  businessPagesPath = _path\n}\n\nmodule.exports = init\n"]}