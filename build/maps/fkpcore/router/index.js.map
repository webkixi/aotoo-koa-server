{"version":3,"sources":["fkpcore/router/index.js"],"names":["app","prefix","options","ctx","next","ignoreStacic","indexOf","params","cat","dealwithRoute","fkp","staticMapper","_controlPages","console","log","stack","forBetter","controlPages","DEBUG","router","Router","routeParam","_","isPlainObject","customControl","map","item","key","includes","Array","isArray","forEach","rt","get","_path","post","use","routes","allowedMethods","init","_mapper","ctrlPages","isRender","filterRendeFile","url","route","makeRoute","fkproute","routerPrefix","opts","myStore","append","runtime","pageData","distribute","routerInstance","controler","pdata","renderPage","_pageData","ctrl","_names","set","_filename","Path","resolve","__dirname","fs","existsSync","_stat","statSync","isFile","push","length","controlConfig","require","getData","call","run","nomatch","getctrlData","isString","replace","control","passAccess","initStat","store","xData","controlFile","sep","businessPagesPath","prefixRootFile","join","prefixIndexFile","prefixCatFile","paramsCatFile","xRoute","apilist","Fetch","list","isAjax","data","preRender","method","getStat","local","query","_stat_","body","Error","render","error","debug","glob","Url","md5","SAX","default","getObjType","object","Object","prototype","toString","match","toLowerCase","pms","rjson","parse","rtn","ext","exts","tempExts","noPassCat","businessPages","mkdirSync","controlPagePath","_id","ctrlFiles","Cache","ifid","res","rej","getCtrlFiles","dir","readdir","err","file","stat","isDirectory","okPath","_url","indexRoot","index","_ext","extname","ctxurl","slice","title","id","gtpy","substring","path_join","jspath","src","mapper","Aotoo","inject","public","js","csspath","css","tmpletStatic","type","jspagesrc","csspagesrc","commonjs","common","commoncss","pagejs","pagecss","pagedata","_route","mydata","myentry","entry","myroute","viewsRoot","state","viewsFiles","views","absOriRoute","getRoute","pages","module","exports"],"mappings":"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","file":"../../../fkpcore/router/index.js","sourcesContent":["/**\n * Module dependencies.\n */\nconst DEBUG = debug('fkp:router')\nconst fs = require('fs');\nconst glob = require('glob')\nconst Path = require('path')\nconst Url = require('url')\nconst Router = require('koa-router')\nconst md5 = require('blueimp-md5')\nconst myStore = SAX('AOTOO-KOA-SERVER')\nconst control = require('./control').default\n// const businessPagesPath = '../../pages'\nlet businessPagesPath = ''\n\nfunction getObjType(object) {\n  return Object.prototype.toString.call(object).match(/^\\[object\\s(.*)\\]$/)[1].toLowerCase();\n};\n/**\n * 过滤渲染文件\n * {param1} {json}   this.params\n * {param2} {json}   json of parse this.path\n * return   {boleean}\n**/\nfunction filterRendeFile(pms, url) {\n  let rjson = Path.parse(url)\n  let rtn = false;\n  let ext = rjson.ext;\n  let cat = pms.cat;\n\n  let exts = ['.css', '.js', '.swf', '.jpg', '.jpeg', '.png', '.bmp', '.ico'];\n  let tempExts = ['.html', '.shtml'];\n  let noPassCat = ['css', 'js', 'img', 'imgs', 'image', 'images'];\n\n  if (!ext) rtn = true;\n\n  if (_.indexOf(tempExts, ext) > -1) rtn = true;\n  if (_.indexOf(noPassCat, cat) > -1) rtn = false;\n\n  return rtn;\n}\n\n// 预读取pages目录下的所有文件路径，并保存\nfunction controlPages() {\n  // const businessPages = Path.join(__dirname, businessPagesPath)\n  const businessPages = businessPagesPath\n  if (!fs.existsSync(businessPages)) {\n    fs.mkdirSync(businessPages, '0777')\n  }\n  DEBUG('businessPages %s', businessPages)\n  const controlPagePath = businessPages\n  const _id = controlPagePath\n  let ctrlFiles = []\n  return Cache.ifid(_id, () => new Promise((res, rej) => {\n    return function getCtrlFiles(dir) {\n      fs.readdir(dir, (err, data) => {\n        if (err) throw err\n        data.map(file => {\n          const _path = Path.join(dir, file)\n          const stat = fs.statSync(_path)\n          if (stat && stat.isDirectory()) return getCtrlFiles(_path)\n          const okPath = _path.replace(controlPagePath, '')\n          ctrlFiles.push(okPath)\n          // ctrlFiles.push(Path.join(okPath))\n        }) // end map\n        Cache.set(_id, ctrlFiles)\n        res(ctrlFiles)\n      })\n    }(controlPagePath)\n  })\n  )\n}\n\nfunction makeRoute(ctx, prefix) {\n  let params = ctx.params\n  let _url = ctx.url\n  const fkp = ctx.fkp\n  const indexRoot = fkp.index\n  ctx.local = Url.parse(ctx.url, true)\n\n\n  let _ext = Path.extname(ctx.url)\n  let ctxurl = ctx.url.slice(1).replace(_ext, '') || ''\n\n  if (_url.indexOf('?') > -1) {\n    _url = _url.slice(0, _url.indexOf('?'))\n    ctxurl = ctxurl.slice(0, ctxurl.indexOf('?'))\n  }\n  let rjson = Path.parse(_url)\n  let route = false\n  let cat = params.cat || '', title = params.title || '', id = params.id || '';\n  let gtpy = getObjType;\n\n  if (id) {\n    gtpy(id) === 'number'\n      ? route = title\n        ? cat + '/' + title\n        : cat\n      : route = cat + '/' + title + '/' + id\n  }\n\n  else if (title) {\n    title = title.replace(rjson.ext, '');\n    route = gtpy(title) === 'number' ? cat : cat + '/' + title\n  }\n\n  else if (cat) {\n    cat = cat.replace(rjson.ext, '');\n    route = gtpy(cat) === 'number' ? indexRoot || 'index' : cat\n  }\n\n  else {\n    route = indexRoot || 'index'\n  }\n  if (ctxurl && route !== ctxurl) route = ctxurl\n  if (prefix) route = prefix.indexOf('/') == 0 ? prefix.substring(1) : prefix\n  return route\n}\n\nfunction path_join(jspath, src) {\n  if (jspath.indexOf('http') == 0 || jspath.indexOf('//') == 0) {\n    return Url.resolve(jspath, src)\n  } else {\n    return Path.join(jspath, src)\n  }\n}\n\nfunction staticMapper(ctx, mapper, route, routerPrefix) {\n  const jspath = Aotoo.inject.public.js\n  const csspath = Aotoo.inject.public.css\n  let tmpletStatic = (src, type) => {\n    if (type == 'js') {\n      const jspagesrc = path_join(jspath, src)\n      return '<script type=\"text/javascript\" src=\"' + jspagesrc + '\" ></script>'\n    }\n    if (type == 'css') {\n      const csspagesrc = path_join(csspath, src)\n      return '<link rel=\"stylesheet\" href=\"' + csspagesrc + '\" />'\n    }\n  }\n\n  if (_.isString(routerPrefix) && routerPrefix.indexOf('/') == 0) routerPrefix = routerPrefix.replace('/', '')\n  if (!mapper) return false\n  let pageData = {\n    //静态资源\n    commonjs: tmpletStatic((mapper.js.common || 'common.js'), 'js'),   //公共css\n    commoncss: tmpletStatic((mapper.css.common || 'common.css'), 'css'), //公共js\n    pagejs: '',\n    pagecss: '',\n    pagedata: {}\n  }\n  //静态资源初始化\n  if (mapper.css[route]) pageData.pagecss = tmpletStatic(mapper.css[route], 'css')\n  if (mapper.js[route]) pageData.pagejs = tmpletStatic(mapper.js[route], 'js')\n\n  let _route = route\n  if (routerPrefix) {\n    _route = routerPrefix\n    if (mapper.css[_route]) pageData.pagecss = tmpletStatic(mapper.css[_route], 'css')\n    if (mapper.js[_route]) pageData.pagejs = tmpletStatic(mapper.js[_route], 'js')\n  }\n\n  return pageData\n}\n\n/**\n * 路由分配\n * {param1} koa implement\n * {param2} map of static file\n * return rende pages\n**/\nasync function init(app, prefix, options) {\n  let _controlPages = await controlPages()\n  DEBUG('control pages === %O', _controlPages)\n  const router = prefix ? new Router({ prefix: prefix }) : new Router()\n  const routeParam = [\n    '/',\n    '/:cat',\n    '/:cat/:title',\n    '/:cat/:title/:id'\n  ]\n  if (options && _.isPlainObject(options)) {\n    let customControl = false\n    if (options.customControl) {\n      customControl = options.customControl\n    }\n    _.map(options, (item, key) => {\n      if (_.includes(['get', 'post', 'put', 'del'], key)) {\n        if (typeof item == 'string') item = [item]\n        if (!Array.isArray(item)) return\n        item.forEach(rt => {\n          // if (key!='get' && rt.indexOf('p1')==-1) {\n          if (key != 'get') {\n            if (rt != '/') {\n              router[key](rt, router::(customControl || forBetter))\n            }\n          } else {\n            router[key](rt, router::(customControl || forBetter))\n          }\n        })\n      } else {\n        routeParam.forEach(_path => {\n          router.get(_path, router::(customControl || forBetter))\n          router.post(_path, router::(customControl || forBetter))\n        })\n      }\n    })\n  } else {\n    routeParam.forEach(item => {\n      router.get(item, router::forBetter)\n      if (item != '/') {\n        router.post(item, router::forBetter)\n      }\n    })\n  }\n\n  app.use(router.routes())\n  app.use(router.allowedMethods())\n\n  async function forBetter(ctx, next) {\n    try {\n      let ignoreStacic = ['css', 'js', 'images', 'img']\n      if (ignoreStacic.indexOf(ctx.params.cat) > -1) return\n      return await this::dealwithRoute(ctx, ctx.fkp.staticMapper, _controlPages)\n    } catch (e) {\n      console.log(e.stack)\n    }\n  }\n}\n\n/**\n * 路由配置\n * {param1} koa implement\n * {param2} map of static file\n * return rende pages\n**/\nasync function dealwithRoute(ctx, _mapper, ctrlPages) {\n  try {\n    let isRender = filterRendeFile(ctx.params, ctx.url)\n    let route = isRender ? makeRoute(ctx) : false\n    if (!route) throw 'route配置不正确'\n    ctx.fkproute = route\n    let routerPrefix = this.opts.prefix\n    ctx.routerPrefix = routerPrefix\n    myStore.append({\n      route: {\n        runtime: {\n          route: route,\n          prefix: routerPrefix\n        }\n      }\n    })\n    DEBUG('dealwithRoute route = %s', route)\n    DEBUG('dealwithRoute routerPrefix = %s', routerPrefix)\n\n    let pageData = staticMapper(ctx, _mapper, route, routerPrefix)\n    if (!pageData) throw 'mapper数据不正确'\n    return ctx::distribute(route, pageData, ctrlPages, this)\n  } catch (e) {\n    DEBUG('dealwithRoute error = %O', e)\n    // console.log(e);\n    // return ctx.redirect('404')\n  }\n}\n\n// 分发路由\nasync function distribute(route, pageData, ctrlPages, routerInstance) {\n  let [pdata, rt] = await controler(this, route, pageData, ctrlPages, routerInstance)\n  return await renderPage(this, rt, pdata)\n}\n\n\n// match的control文件，并返回数据\nasync function getctrlData(_path, route, ctx, _pageData, ctrl) {\n  try {\n    let _names = []\n    ctrl.set('route', route)\n    if (Array.isArray(_path)) {\n      for (let _filename of _path) {\n        _filename = Path.resolve(__dirname, _filename + '.js')\n        if (fs.existsSync(_filename)) {\n          let _stat = fs.statSync(_filename)\n          if (_stat && _stat.isFile()) _names.push(_filename)\n        }\n      }\n    }\n    if (_names.length) {\n      let controlConfig = require(_names[0]).getData.call(ctx, _pageData)\n      _pageData = await ctrl.run(ctx, controlConfig)\n    } else {\n      _pageData = false\n    }\n    return _pageData\n  } catch (e) {\n    DEBUG('getctrlData error = %O', e)\n    return { nomatch: true }\n  }\n}\n\nasync function controler(ctx, route, pageData, ctrlPages, routerInstance) {\n  let routerPrefix = routerInstance.opts.prefix\n  if (_.isString(routerPrefix) && routerPrefix.indexOf('/') == 0) routerPrefix = routerPrefix.replace('/', '')\n\n  try {\n    let ctrl = control(route, ctx, pageData, routerInstance)\n    let passAccess = false\n    if (ctrl.initStat) {\n      pageData = await ctrl.run(ctx)\n      route = ctrl.store.route || route\n    } else {\n\n      let xData = false\n      // 根据route匹配到control文件+三层路由\n      const controlFile = Path.sep + route + '.js'\n      if (ctrlPages.indexOf(controlFile) > -1) {\n        xData = await getctrlData([businessPagesPath + '/' + route], route, ctx, pageData, ctrl)\n      }\n      // 根据prefix匹配到control文件+三层路由\n      else if (routerPrefix) {\n        route = routerPrefix\n        let prefixRootFile = Path.join(businessPagesPath, routerPrefix)\n        let prefixIndexFile = Path.join(businessPagesPath, routerPrefix, '/index')\n        let prefixCatFile = Path.join(businessPagesPath, routerPrefix, ctx.params.cat || '')\n        xData = await getctrlData([prefixCatFile, prefixIndexFile, prefixRootFile], route, ctx, pageData, ctrl)\n      }\n      // pages根目录+三层路由\n      else {\n        if (ctx.params.cat) {\n          let paramsCatFile = Path.join(businessPagesPath, ctx.params.cat)\n          const xRoute = ctx.params.cat\n          xData = await getctrlData([paramsCatFile], xRoute, ctx, pageData, ctrl)\n        }\n      }\n      // 根据 Fetch.apilist 匹配到api接口，从远程借口拿去数据\n      if (!xData) {\n        let apilist = Fetch.apilist\n        if (apilist.list[route] || route === 'redirect') {\n          passAccess = true\n          xData = await getctrlData(['./passaccesscontrol'], route, ctx, pageData, ctrl)\n        } else {\n          xData = { nomatch: true }\n        }\n      }\n      const isAjax = ctx.fkp.isAjax()\n      if (passAccess || isAjax) pageData = xData\n    }\n    return [pageData, route]\n  } catch (e) {\n    DEBUG('controler error = %O', e)\n    // console.log(e.stack);\n  }\n}\n\nfunction preRender(rt) {\n  const mydata = myStore.get()\n  const myentry = mydata.entry\n  const myroute = mydata.route.runtime.route\n  const viewsRoot = myentry.state.viewsRoot\n  const viewsFiles = myentry.state.views\n  if (rt != myroute) {\n    const absOriRoute = Path.join(viewsRoot, myroute + '.html')\n    if (viewsFiles.indexOf(absOriRoute) > -1) {\n      return myroute\n    }\n  }\n  return rt\n}\n\n// dealwith the data from controlPage\nasync function renderPage(ctx, route, data, isAjax) {\n  try {\n    DEBUG('renderPage pageData = %O', data)\n    DEBUG('renderPage route = %s', route)\n    route = preRender(route)\n    switch (ctx.method) {\n      case 'GET':\n        let getStat = ctx.local.query._stat_\n        if ((getStat && getStat === 'DATA') || isAjax) return ctx.body = data\n        if (data && data.nomatch) throw new Error('你访问的页面/api不存在')\n        return await ctx.render(route, data)\n      case 'POST':\n        return ctx.body = data\n    }\n  } catch (e) {\n    if (isAjax) {\n      ctx.body = {\n        error: '找不到相关信息'\n      }\n    } else {\n      ctx.body = \"<div>找不到页面，呃！</div>\"\n    }\n    // return await ctx.render('404')\n  }\n}\n\ninit.makeRoute = makeRoute\ninit.getRoute = makeRoute\ninit.staticMapper = staticMapper\ninit.renderPage = renderPage\ninit.pages = function (_path) {\n  businessPagesPath = _path\n}\n\nmodule.exports = init\n"]}