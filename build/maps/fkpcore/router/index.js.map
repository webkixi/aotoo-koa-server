{"version":3,"sources":["fkpcore/router/index.js"],"names":["app","prefix","options","controlPages","_controlPages","AotooConfigs","AKSHOOKS","get","context","configs","allMethods","routerOptions","router","Router","customControl","myOptions","_","merge","parameters","betterControl","control_custrom","call","control_mirror","isPlainObject","defineMyRouter","map","rules","key","methodKey","toLowerCase","indexOf","concat","forEach","rule","use","routes","allowedMethods","init","ctx","route","pageData","ctrlPages","routerInstance","xData","undefined","hitControlFile","passAccess","isAjax","fkp","routerPrefix","opts","isString","replace","controlFile","Path","sep","getctrlData","businessPagesPath","hitedControlFile","join","controlIndexFile","controlCatFile","params","cat","item_file","item","push","paramsCatFile","xRoute","existsControlFun","fs","existsSync","apilist","Fetch","list","controler","_path","_pageData","_names","Array","isArray","_filename","resolve","__dirname","controlFun","controlConfig","control","Error","controlModule","require","getData","DEBUG","data","emit","method","body","render","renderPage","debug","Promise","glob","Url","md5","SAX","promisifyAll","ignoreStacic","getObjType","object","Object","prototype","toString","match","filterRendeFile","pms","url","decodeURIComponent","rjson","parse","rtn","ext","exts","tempExts","noPassCat","includes","getCtrlFiles","dir","controlFiles","stat","statSync","isDirectory","_partten","sync","obj","xxx","test","name","businessPages","mkdirSync","controlPagePath","_id","Cache","ifid","__cfile","set","err","console","error","stack","makeRoute","_url","indexRoot","index","local","_ext","extname","ctxurl","slice","title","id","gtpy","substring","lastIndexOf","length","path_join","jspath","src","charAt","tmpletStatic","type","Aotoo","inject","public","js","csspath","css","jspagesrc","csspagesrc","staticMapper","mapper","urlObj","pathname","commonjs","common","commoncss","pagejs","pagecss","pagedata","_route","append","myControl","next","control_ctx_variable","fkproute","control_error","bind","pdata","rt","xdata","preRender","isRender","aotooRoutePath","aotooRoutePrefix","hooksKey","path","message","beforeError","status","log","afterError","mydata","myroute","viewsRoot","state","absOriRoute","viewsFiles","views","getRoute","pages","module","exports"],"mappings":"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","file":"../../../fkpcore/router/index.js","sourcesContent":["/**\n * Module dependencies.\n */\nconst DEBUG = debug('AKS:ROUTER')\nlet fs = require('fs');\nconst Promise = require('bluebird')\nconst glob = require('glob')\nconst Path = require('path')\nconst Url = require('url')\nconst Router = require('koa-router')\nconst md5 = require('blueimp-md5')\nconst AKSHOOKS = SAX('AOTOO-KOA-SERVER')\n// const control = require('./control').default\nconst control = require('./control')\nfs = Promise.promisifyAll(fs)\n\nlet businessPagesPath = ''\nconst ignoreStacic = ['css', 'js', 'images', 'img']\n\nfunction getObjType(object) {\n  return Object.prototype.toString.call(object).match(/^\\[object\\s(.*)\\]$/)[1].toLowerCase();\n};\n\n/**\n * 过滤渲染文件\n * {param1} {json}   this.params\n * {param2} {json}   json of parse this.path\n * return   {boleean}\n**/\nfunction filterRendeFile(pms, url) {\n  url=url.replace(/\\?\\S*$/,'') // 避免?key=value参数影响ext判断\n\n  url=decodeURIComponent(url)\n  \n  let rjson = Path.parse(url)\n  let rtn = false;\n  let ext = rjson.ext;\n  let cat = pms.cat;\n\n  let exts = ['.css', '.js', '.swf', '.jpg', '.jpeg', '.png', '.bmp', '.ico'];\n  let tempExts = ['.html', '.shtml'];\n  let noPassCat = ['css', 'js', 'img', 'imgs', 'image', 'images'];\n\n  if (!ext) rtn = true;\n\n  return !ext || tempExts.includes(ext)>-1 || noPassCat.includes(cat)==-1\n\n  // if (_.indexOf(tempExts, ext) > -1) rtn = true;\n  // if (_.indexOf(noPassCat, cat) > -1) rtn = false;\n\n  // return rtn;\n}\n\n/**\n * \n * @param {String} dir 遍历的目标目录\n * @param {String} rootpath 根目录的绝对路径\n */\n// async function getCtrlFiles(dir, rootpath) {\n//   const __myControlFiles = []\n//   const dirData = await fs.readdirAsync(dir)\n//   dirData.map(async (file) => {\n//     const _path = Path.join(dir, file)\n//     const stat = fs.statSync(_path)\n//     if (stat) {\n//       if (stat.isDirectory()) {\n//         __myControlFiles.concat(await getCtrlFiles(_path, rootpath))\n//       } else {\n//         __myControlFiles.push(_path.replace(rootpath, ''))\n//       }\n//     }\n//   })\n//   return __myControlFiles\n// }\n\nfunction getCtrlFiles(dir, opts = {}) {\n  var controlFiles = []\n  if (!fs.existsSync(dir)) return;\n  const stat = fs.statSync(dir)\n  if (!stat.isDirectory()) return\n\n  const _partten = /^[_\\.](\\w)+/;   // ?? 不兼容windows\n  glob.sync(dir + '/**/*').forEach(function (item) {\n    var obj = Path.parse(item)\n    const xxx = _partten.test(obj.name)\n    if (!xxx) {\n      if (obj.ext) {\n        controlFiles.push(item.replace(dir, ''))\n      }\n    }\n  })\n  return controlFiles\n};\n\n// 预读取pages目录下的所有文件路径，并保存\nfunction controlPages() {\n  // const businessPages = Path.join(__dirname, businessPagesPath)\n  const businessPages = businessPagesPath\n\n  if (!fs.existsSync(businessPages)) {\n    fs.mkdirSync(businessPages, '0777')\n  }\n\n  const controlPagePath = businessPages\n  const _id = controlPagePath\n\n  try {\n    if (fs.existsSync(controlPagePath)) {\n      return Cache.ifid(_id, async () => {\n        const __cfile = await getCtrlFiles(controlPagePath, controlPagePath); Cache.set(_id, __cfile)\n        return __cfile\n      })\n    } else {\n      throw new Error('控制层目录不存在')\n    }\n  } catch (err) {\n    console.error(err.stack);\n  }\n\n  // let ctrlFiles = []\n  // return Cache.ifid(_id, () => new Promise((res, rej) => {\n  //   return function getCtrlFiles(dir) {\n  //     fs.readdir(dir, (err, data) => {\n  //       if (err) throw err\n  //       data.map(file => {\n  //         const _path = Path.join(dir, file)\n  //         const stat = fs.statSync(_path)\n  //         if (stat && stat.isDirectory()) return getCtrlFiles(_path)\n  //         const okPath = _path.replace(controlPagePath, '')\n  //         ctrlFiles.push(okPath)\n  //         // ctrlFiles.push(Path.join(okPath))\n  //       }) // end map\n  //       Cache.set(_id, ctrlFiles)\n  //       res(ctrlFiles)\n  //     })\n  //   }(controlPagePath)\n  // })\n  // )\n}\n\nfunction makeRoute(ctx, prefix) {\n  let params = ctx.params\n  let _url = ctx.url\n  const fkp = ctx.fkp\n  const indexRoot = fkp.index\n  ctx.local = Url.parse(ctx.url, true)\n\n  let _ext = Path.extname(ctx.url)\n  let ctxurl = ctx.url.slice(1).replace(_ext, '') || ''\n\n  if (_url.indexOf('?') > -1) {\n    _url = _url.slice(0, _url.indexOf('?'))\n    ctxurl = ctxurl.slice(0, ctxurl.indexOf('?'))\n  }\n  let rjson = Path.parse(_url)\n  let route = false\n  let cat = params.cat || '', title = params.title || '', id = params.id || '';\n  let gtpy = getObjType;\n\n  if (id) {\n    gtpy(id) === 'number'\n      ? route = title\n        ? cat + '/' + title\n        : cat\n      : route = cat + '/' + title + '/' + id\n  }\n\n  else if (title) {\n    title = title.replace(rjson.ext, '');\n    route = gtpy(title) === 'number' ? cat : cat + '/' + title\n  }\n\n  else if (cat) {\n    cat = cat.replace(rjson.ext, '');\n    route = gtpy(cat) === 'number' ? indexRoot || 'index' : cat\n  }\n\n  else {\n    route = indexRoot || 'index'\n  }\n  if (ctxurl && route !== ctxurl) route = ctxurl\n  if (prefix) route = prefix.indexOf('/') == 0 ? prefix.substring(1) : prefix\n  if (route.lastIndexOf('/') == (route.length - 1)) {\n    route = route.substring(0, route.length - 1)\n  }\n  return route\n}\n\nfunction path_join(jspath, src) {\n  if (jspath.indexOf('http') == 0 || jspath.indexOf('//') == 0) {\n    if (jspath.charAt(jspath.length - 1) == '/') {\n      jspath = jspath.substring(0, jspath.length - 1)\n    }\n    if (src.charAt(0) == '/') {\n      return jspath + src\n    } else {\n      return jspath + '/' + src\n    }\n  } else {\n    return Path.join(jspath, src);\n  }\n}\n\nconst tmpletStatic = (src, type) => {\n  const jspath = Aotoo.inject.public.js\n  const csspath = Aotoo.inject.public.css\n  if (type == 'js') {\n    const jspagesrc = path_join(jspath, src)\n    return '<script type=\"text/javascript\" src=\"' + jspagesrc + '\" ></script>'\n  }\n  if (type == 'css') {\n    const csspagesrc = path_join(csspath, src)\n    return '<link rel=\"stylesheet\" href=\"' + csspagesrc + '\" />'\n  }\n}\n\nfunction staticMapper(ctx, mapper, route, routerPrefix) {\n  const urlObj = Url.parse(ctx.url)\n  const _id = md5(urlObj.pathname)\n  \n  return Cache.ifid(_id, () => {\n    if (_.isString(routerPrefix) && routerPrefix.indexOf('/') == 0) routerPrefix = routerPrefix.replace('/', '')\n    if (!mapper) return false\n    let pageData = {\n      //静态资源\n      commonjs: tmpletStatic((mapper.js.common || 'common.js'), 'js'),   //公共css\n      commoncss: tmpletStatic((mapper.css.common || 'common.css'), 'css'), //公共js\n      pagejs: '',\n      pagecss: '',\n      pagedata: {}\n    }\n    //静态资源初始化\n    if (route.indexOf('/') == 0) route = route.substring(1)\n    if (route.lastIndexOf('/') == (route.length - 1)) route = route.substring(0, route.length - 1)\n    if (mapper.css[route]) pageData.pagecss = tmpletStatic(mapper.css[route], 'css')\n    if (mapper.js[route]) pageData.pagejs = tmpletStatic(mapper.js[route], 'js')\n  \n    let _route = route\n    if (routerPrefix) {\n      _route = routerPrefix\n      if (mapper.css[_route]) pageData.pagecss = tmpletStatic(mapper.css[_route], 'css')\n      if (mapper.js[_route]) pageData.pagejs = tmpletStatic(mapper.js[_route], 'js')\n    }\n    \n    Cache.set(_id, pageData)\n    return pageData\n  })\n}\n\nfunction defineMyRouter(myOptions, router, prefix, customControl, controlPages) {\n  const allMethods = AKSHOOKS.get().context.configs.routerOptions.allMethods\n  const betterControl = customControl ? control_custrom.call(router, router, customControl) : control_mirror.call(router, router, controlPages)\n  _.map(myOptions, (rules, key)=>{\n    const methodKey = key.toLowerCase()\n    if (allMethods.indexOf(methodKey) > -1) {\n      rules = [].concat(rules)\n      rules.forEach( rule=>{\n        router[methodKey](rule, betterControl)\n      })\n    } else {\n      if (prefix) {\n        AKSHOOKS.append({ [prefix]: {\n          [key]: rules\n        }})\n      }\n    }\n  })\n}\n\n/**\n * 路由分配\n * {param1} koa implement\n * {param2} map of static file\n * return rende pages\n**/\nasync function init(app, prefix, options) {\n  let _controlPages = await controlPages()\n  const AotooConfigs = AKSHOOKS.get().context.configs\n  const allMethods = AotooConfigs.routerOptions.allMethods\n  const router = (()=>{\n    if (prefix) {\n      return new Router({prefix})\n    } else {\n      return new Router()\n    }\n  })()\n  let customControl\n  if (options&&options.customControl) {\n    customControl = options.customControl\n    delete options.customControl\n  }\n  const myOptions = _.merge({}, AotooConfigs.routerOptions.parameters, options)\n  const betterControl = customControl ? control_custrom.call(router, router, customControl) : control_mirror.call(router, router, _controlPages)\n  if (_.isPlainObject(options)) {\n    defineMyRouter(myOptions, router, prefix, customControl, _controlPages)\n  } else {\n    _.map(myOptions, (rules, key) => {\n      const methodKey = key.toLowerCase()\n      if (allMethods.indexOf(methodKey) > -1) {\n        rules = [].concat(rules)\n        rules.forEach( rule => router[methodKey](rule, betterControl) )\n      }\n    })\n  }\n  app.use(router.routes())\n  app.use(router.allowedMethods())\n}\n\nfunction control_custrom(router, myControl) {\n  return async function(ctx, next){\n    try {\n      control_ctx_variable(ctx, router)\n      if (ctx.fkproute) {\n        return await myControl.call(router, ctx, next)\n      }\n    } catch (err) {\n      return control_error(err, ctx)\n    }\n  }.bind(this)\n}\n\nfunction control_mirror(router, ctrlPages) {\n  return async function(ctx, next){\n    const isAjax = ctx.fkp.isAjax(ctx)\n    try {\n      control_ctx_variable(ctx, router)\n      if (ctx.fkproute) {\n        let pageData = staticMapper(ctx, ctx.fkp.staticMapper, ctx.fkproute, ctx.routerPrefix)\n        if (pageData) {\n          let [pdata, rt, xdata, hitControlFile] = await controler(ctx, ctx.fkproute, pageData, ctrlPages, router)\n          rt = preRender(rt, ctx)\n          // return await renderPage(ctx, rt, pdata)\n          if (xdata) {\n            if (hitControlFile) {\n              return await renderPage(ctx, rt, pdata)\n            }\n          } else {\n            if (!hitControlFile) {\n              return await renderPage(ctx, rt, pdata)\n            }\n          }\n        }\n      }\n    } catch (err) {\n      return control_error(err, ctx)\n    }\n  }.bind(this)\n}\n\nfunction control_ctx_variable(ctx, router) {\n  let routerPrefix = router.opts.prefix\n  let isRender = filterRendeFile(ctx.params, ctx.url)\n  let route = isRender ? makeRoute(ctx) : false\n  DEBUG('router path = %s', route)\n  DEBUG('router prefix = %s', routerPrefix)\n  if (route) {\n    ctx.fkproute = ctx.aotooRoutePath = route\n    ctx.routerPrefix = ctx.aotooRoutePrefix = routerPrefix\n    const hooksKey = routerPrefix ? Path.join(routerPrefix, route||'') : route\n    ctx.hooksKey = hooksKey\n    AKSHOOKS.append({\n      [hooksKey]: { \"runtime\": {\n        route: route,\n        prefix: routerPrefix,\n        path: hooksKey\n      }}\n    })\n  }\n}\n\nfunction control_error(err, ctx) {\n  const message = err.message\n  const route = ctx.routerPrefix || ctx.fkproute\n  const isAjax = ctx.fkp.isAjax(ctx)\n  if (route === '404') {\n    return ctx.body = '您访问的页面不存在'\n  }\n\n  const beforeError = AKSHOOKS.emit('beforeError', {err, ctx, isAjax})\n  if (beforeError) return beforeError\n\n  switch (message) {\n    case '404':\n      ctx.status = 404\n      console.log('========= 路由访问错误或模板文件不存在 ==========')\n      console.log(err)\n      break;\n    default:\n      console.log(err)\n      break;\n  }\n\n  const afterError = AKSHOOKS.emit('afterError', {err, ctx, isAjax})\n  if (afterError) return afterError\n}\n\n\nasync function controler(ctx, route, pageData, ctrlPages, routerInstance) {\n  let xData = undefined\n  let hitControlFile = false\n  let passAccess = false\n  let isAjax = ctx.fkp.isAjax(ctx)\n  let routerPrefix = routerInstance.opts.prefix\n  if (_.isString(routerPrefix) && routerPrefix.indexOf('/') == 0) {\n    routerPrefix = routerPrefix.replace('/', '')\n  }\n  // 根据route匹配到control文件+三层路由\n  const controlFile = Path.sep + route + '.js'\n  if (ctrlPages.indexOf(controlFile) > -1) {\n    hitControlFile = true\n    xData = await getctrlData([businessPagesPath + '/' + route], route, ctx, pageData, routerInstance)\n  }\n  // 根据prefix匹配到control文件+三层路由\n  else if (routerPrefix) {\n    route = routerPrefix\n    const hitedControlFile = []\n    const controlFile = Path.join(Path.sep, routerPrefix)\n    const controlIndexFile = Path.join(Path.sep, routerPrefix, 'index')\n    const controlCatFile = Path.join(Path.sep, routerPrefix, (ctx.params.cat||''))\n    Array.forEach([controlFile, controlIndexFile, controlCatFile], item => {\n      const item_file = item + '.js'\n      if (ctrlPages.indexOf(item_file) > -1) {\n        hitControlFile = true\n        hitedControlFile.push(Path.join(businessPagesPath, item))\n      }\n    })\n    \n    xData = await getctrlData(hitedControlFile, route, ctx, pageData, routerInstance)\n  }\n  // pages根目录+三层路由\n  else {\n    if (ctx.params.cat) {\n      let paramsCatFile = Path.join(businessPagesPath, ctx.params.cat)\n      let controlFile = paramsCatFile+'.js'\n      const xRoute = ctx.params.cat\n      if (existsControlFun[controlFile] || fs.existsSync(controlFile)) {\n        hitControlFile = true\n      }\n      xData = await getctrlData([paramsCatFile], xRoute, ctx, pageData, routerInstance)\n    }\n  }\n  // 根据 Fetch.apilist 匹配到api接口，从远程借口拿去数据\n  if (!xData) {\n    let apilist = Fetch.apilist\n    if (apilist.list[route] || route === 'redirect') {\n      passAccess = true\n      hitControlFile = true\n      xData = await getctrlData(['./passaccesscontrol'], route, ctx, pageData, routerInstance)\n    }\n  }\n  \n  // xData = { nomatch: true }\n  // if (passAccess || isAjax) pageData = xData\n  // return [pageData, route]\n  \n  pageData = xData || pageData\n  return [pageData, route, xData, hitControlFile]\n}\n\nvar existsControlFun = {}\n// match的control文件，并返回数据\nasync function getctrlData(_path, route, ctx, _pageData, routerInstance) {\n  let _names = []\n  if (Array.isArray(_path)) {\n    for (let _filename of _path) {\n      _filename = Path.resolve(__dirname, _filename + '.js')\n      _names.push(_filename)\n    }\n  }\n\n  if (existsControlFun[_names[0]]) {\n    const controlFun = existsControlFun[_names[0]]\n    const controlConfig = controlFun ? controlFun.call(ctx, _pageData) : undefined\n    if (controlConfig) {\n      return await control(route, ctx, _pageData, routerInstance, controlConfig)\n    } else {\n      throw new Error('控制器文件不符合规范')\n    }\n  }\n\n  if (fs.existsSync(_names[0])) {\n    const controlModule = require(_names[0])\n    if (controlModule) {\n      const controlFun = typeof controlModule == 'function' \n      ? controlModule \n      : controlModule.getData && controlModule.getData && typeof controlModule.getData == 'function' \n      ? controlModule.getData \n      : undefined\n\n      if (controlFun) {\n        existsControlFun[_names[0]] = controlFun\n        const controlConfig = controlFun ? controlFun.call(ctx, _pageData) : undefined\n        if (controlConfig) {\n          _pageData = await control(route, ctx, _pageData, routerInstance, controlConfig)\n        } else {\n          throw new Error('控制器文件不符合规范')\n        }\n      }\n    } else {\n      _pageData = undefined\n    }\n  } else {\n    _pageData = undefined\n  }\n  DEBUG('getctrlData return = %O', _pageData)\n  return _pageData\n}\n\nfunction preRender(rt, ctx) {\n  if (rt) {\n    const mydata = AKSHOOKS.get()\n    const context = mydata.context   // aotoo-koa-server entry instance\n    const myroute = ctx.fkproute\n    const prefix = ctx.routerPrefix\n    const viewsRoot = context.state.viewsRoot\n    const absOriRoute = Path.join(viewsRoot, myroute + '.html')\n    const viewsFiles = context.state.views\n  \n    if (prefix) {\n      return rt\n    }\n  \n    if (viewsFiles.indexOf(absOriRoute)>-1) {\n      return rt === myroute ? rt : myroute\n    }\n  }\n}\n\n// dealwith the data from controlPage\nasync function renderPage(ctx, route, data) {\n  const isAjax = ctx.fkp.isAjax(ctx)\n  data = AKSHOOKS.emit('beforeRender', data) || data\n  switch (ctx.method) {\n    case 'GET':\n      if (isAjax) return ctx.body = data\n      if (route) {\n        return await ctx.render(route, data)\n      } else {\n        throw new Error('404') // 路由访问错误或模板文件不存在\n      }\n    case 'POST':\n      return ctx.body = data\n  }\n\n  // try {\n  //   DEBUG('renderPage pageData = %O', data)\n  //   DEBUG('renderPage route = %s', route)\n  //   route = preRender(route, ctx)\n  //   if (route) {\n  //     data = AKSHOOKS.emit('pageWillRender', data) || data\n  //     switch (ctx.method) {\n  //       case 'GET':\n  //         if (isAjax) return ctx.body = data\n  //         return await ctx.render(route+'.html', data)\n  //       case 'POST':\n  //         return ctx.body = data\n  //     }\n  //   } else {\n  //     throw new Error('路由访问错误或模板文件不存在')\n  //   }\n  // } catch (e) {\n  //   console.log(e);\n  //   AKSHOOKS.emit('pageRenderError', { err: e, isAjax, ctx })\n  //   if (isAjax) {\n  //     ctx.body = {\n  //       error: 'node - 找不到相关信息'\n  //     }\n  //   } else {\n  //     ctx.status = 404\n  //     if (route == '404') {\n  //       ctx.body = '您访问的页面不存在!'\n  //     } else {\n  //       if (AKSHOOKS.hasOn('404')) {\n  //         return await AKSHOOKS.emit('404', ctx)\n  //       }\n  //       return await ctx.redirect('/404')\n  //     }\n  //     // return await ctx.render('404')\n  //   }\n  // }\n}\n\ninit.makeRoute = makeRoute\ninit.getRoute = makeRoute\ninit.staticMapper = staticMapper\ninit.renderPage = renderPage\ninit.pages = function (_path) {\n  businessPagesPath = _path\n}\n\nmodule.exports = init\n"]}