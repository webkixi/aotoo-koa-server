{"version":3,"sources":["fkpcore/router/index.js"],"names":["app","prefix","options","ctx","next","ignoreStacic","indexOf","params","cat","dealwithRoute","fkp","staticMapper","_controlPages","console","log","stack","forBetter","controlPages","DEBUG","router","Router","routeParam","_","isPlainObject","customControl","map","item","key","includes","Array","isArray","forEach","rt","get","_path","post","use","routes","allowedMethods","init","_mapper","ctrlPages","isRender","filterRendeFile","url","route","makeRoute","fkproute","routerPrefix","opts","pageData","distribute","routerInstance","controler","pdata","renderPage","_pageData","ctrl","_names","set","_filename","Path","resolve","__dirname","fs","existsSync","_stat","statSync","isFile","push","length","controlConfig","require","getData","call","run","nomatch","getctrlData","isString","replace","control","passAccess","initStat","store","xData","controlFile","sep","businessPagesPath","prefixIndexFile","join","prefixCatFile","paramsCatFile","xRoute","apilist","Fetch","list","isAjax","data","method","getStat","local","query","_stat_","body","Error","render","error","debug","Url","md5","default","getObjType","object","Object","prototype","toString","match","toLowerCase","pms","rjson","parse","rtn","ext","exts","tempExts","noPassCat","businessPages","mkdirSync","controlPagePath","_id","ctrlFiles","Cache","ifid","res","rej","getCtrlFiles","dir","readdir","err","file","stat","isDirectory","okPath","_url","indexRoot","index","_ext","extname","ctxurl","slice","title","id","gtpy","substring","mapper","tmpletStatic","src","type","commonjs","js","common","commoncss","css","pagejs","pagecss","pagedata","_route","getRoute","pages","module","exports"],"mappings":"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","file":"../../../fkpcore/router/index.js","sourcesContent":["/**\n * Module dependencies.\n */\nconst DEBUG = debug('fkp:router')\nconst fs = require('fs');\nconst Path = require('path')\nconst Url = require('url')\nconst Router = require('koa-router')\nconst md5 = require('blueimp-md5')\nconst control = require('./control').default\n// const businessPagesPath = '../../pages'\nlet businessPagesPath = ''\n\n\nfunction getObjType(object){\n  return Object.prototype.toString.call(object).match(/^\\[object\\s(.*)\\]$/)[1].toLowerCase();\n};\n/**\n * 过滤渲染文件\n * {param1} {json}   this.params\n * {param2} {json}   json of parse this.path\n * return   {boleean}\n**/\nfunction filterRendeFile(pms, url){\n    let rjson = Path.parse(url)\n    let rtn = false;\n    let ext = rjson.ext;\n    let cat = pms.cat;\n\n    let exts = ['.css','.js','.swf','.jpg','.jpeg','.png','.bmp','.ico'];\n    let tempExts = ['.html','.shtml'];\n    let noPassCat = ['css','js','img','imgs','image','images'];\n\n    if(!ext) rtn = true;\n\n    if(_.indexOf(tempExts, ext) > -1) rtn = true;\n    if(_.indexOf(noPassCat, cat) > -1) rtn = false;\n\n    return rtn;\n}\n\n// 预读取pages目录下的所有文件路径，并保存\nfunction controlPages() {\n  // const businessPages = Path.join(__dirname, businessPagesPath)\n  const businessPages = businessPagesPath\n  if (!fs.existsSync(businessPages)) {\n    fs.mkdirSync(businessPages, '0777')\n  }\n  DEBUG('businessPages %s', businessPages)\n  const controlPagePath = businessPages\n  const _id = controlPagePath\n  let ctrlFiles = []\n  return Cache.ifid( _id, ()=> new Promise((res,rej)=>{\n      return function getCtrlFiles(dir){\n        fs.readdir(dir, (err, data) => {\n          if(err) throw err\n          data.map( file => {\n            const _path = Path.join(dir, file)\n            const stat = fs.statSync(_path)\n            if (stat && stat.isDirectory()) return getCtrlFiles(_path)\n            const okPath = _path.replace(controlPagePath, '')\n            ctrlFiles.push(okPath)\n            // ctrlFiles.push(Path.join(okPath))\n          }) // end map\n          Cache.set(_id, ctrlFiles)\n          res(ctrlFiles)\n        })\n      }(controlPagePath)\n    })\n  )\n}\n\nfunction makeRoute(ctx, prefix){\n  let params = ctx.params\n  let _url = ctx.url\n  const fkp = ctx.fkp\n  const indexRoot = fkp.index\n  ctx.local = Url.parse(ctx.url, true)\n\n\n  let _ext = Path.extname(ctx.url)\n  let ctxurl = ctx.url.slice(1).replace(_ext, '') || ''\n\n  if (_url.indexOf('?')>-1){\n    _url = _url.slice(0, _url.indexOf('?'))\n    ctxurl = ctxurl.slice(0, ctxurl.indexOf('?'))\n  }\n  let rjson = Path.parse(_url)\n  let route = false\n  let cat = params.cat||'', title = params.title||'', id = params.id||'';\n  let gtpy = getObjType;\n\n  if(id){\n    gtpy(id)==='number'\n    ? route = title\n      ? cat+'/'+title\n      : cat\n    : route = cat+'/'+title +'/' + id\n  }\n\n  else if(title){\n    title = title.replace(rjson.ext,'');\n    route = gtpy(title)==='number' ? cat : cat+'/'+title\n  }\n\n  else if(cat){\n    cat = cat.replace(rjson.ext,'');\n    route = gtpy(cat)==='number' ? indexRoot||'index' : cat\n  }\n\n  else{\n    route = indexRoot||'index'\n  }\n  if (ctxurl && route !== ctxurl) route = ctxurl\n  if (prefix) route = prefix.indexOf('/')==0 ? prefix.substring(1) : prefix\n  return route\n}\n\nfunction staticMapper(ctx, mapper, route, routerPrefix){\n  let tmpletStatic = (src, type) => {\n    if (type == 'js') {\n      return '<script type=\"text/javascript\" src=\"/js/'+src+'\" ></script>'\n    }\n    if (type == 'css') {\n      return '<link rel=\"stylesheet\" href=\"/css/'+src+'\" />'\n    }\n  }\n\n  if (_.isString(routerPrefix) && routerPrefix.indexOf('/')==0) routerPrefix = routerPrefix.replace('/','')\n  if (!mapper) return false\n  let pageData = {\n    //静态资源\n    commonjs: tmpletStatic((mapper.js.common||'common.js'), 'js'),   //公共css\n    commoncss: tmpletStatic((mapper.css.common||'common.css'), 'css'), //公共js\n    pagejs: '',\n    pagecss: '',\n    pagedata: {}\n  }\n  //静态资源初始化\n  if(mapper.css[route]) pageData.pagecss = tmpletStatic(mapper.css[route], 'css')\n  if (mapper.js[route]) pageData.pagejs = tmpletStatic(mapper.js[route], 'js')\n\n  let _route = route\n  if (routerPrefix) {\n    _route = routerPrefix\n    if (mapper.css[_route]) pageData.pagecss = tmpletStatic(mapper.css[_route], 'css')\n    if (mapper.js[_route]) pageData.pagejs = tmpletStatic(mapper.js[_route], 'js')\n  }\n\n  return pageData\n}\n\n/**\n * 路由分配\n * {param1} koa implement\n * {param2} map of static file\n * return rende pages\n**/\nasync function init(app, prefix, options) {\n  let _controlPages = await controlPages()\n  DEBUG('control pages === %O', _controlPages)\n  const router = prefix ? new Router({prefix: prefix}) : new Router()\n  const routeParam = [\n    '/',\n    '/:cat',\n    '/:cat/:title',\n    '/:cat/:title/:id'\n  ]\n  if (options && _.isPlainObject(options)) {\n    let customControl = false\n    if (options.customControl) {\n      customControl = options.customControl\n    }\n    _.map(options, (item, key) => {\n      if (_.includes(['get', 'post', 'put', 'del'], key)) {\n        if (typeof item == 'string') item = [item]\n        if (!Array.isArray(item)) return\n        item.forEach( rt=>{\n          // if (key!='get' && rt.indexOf('p1')==-1) {\n          if (key!='get') {\n            if (rt!='/') {\n              router[key](rt, router::(customControl||forBetter))\n            }\n          } else {\n            router[key](rt, router::(customControl||forBetter))\n          }\n        })\n      } else {\n        routeParam.forEach( _path=>{\n          router.get(_path, router::(customControl||forBetter))\n          router.post(_path, router::(customControl||forBetter))\n        })\n      }\n    })\n  } else {\n    routeParam.forEach( item=>{\n      router.get(item, router::forBetter)\n      if (item!='/') {\n        router.post(item, router::forBetter)\n      }\n    })\n  }\n\n  app.use(router.routes())\n  app.use(router.allowedMethods())\n\n  async function forBetter(ctx, next) {\n    try {\n      let ignoreStacic = ['css', 'js', 'images', 'img']\n      if (ignoreStacic.indexOf(ctx.params.cat)>-1) return\n      return await this::dealwithRoute(ctx, ctx.fkp.staticMapper, _controlPages)\n    } catch (e) {\n      console.log(e.stack)\n    }\n  }\n}\n\n/**\n * 路由配置\n * {param1} koa implement\n * {param2} map of static file\n * return rende pages\n**/\nasync function dealwithRoute(ctx, _mapper, ctrlPages){\n  try {\n    let isRender = filterRendeFile(ctx.params, ctx.url)\n    let route = isRender ? makeRoute(ctx) : false\n    if (!route) throw 'route配置不正确'\n    ctx.fkproute = route\n    let routerPrefix = this.opts.prefix\n    ctx.routerPrefix = routerPrefix\n    DEBUG('dealwithRoute route = %s', route)\n    DEBUG('dealwithRoute routerPrefix = %s', routerPrefix)\n  \n    let pageData = staticMapper(ctx, _mapper, route, routerPrefix)\n    if (!pageData) throw 'mapper数据不正确'\n    return ctx::distribute(route, pageData, ctrlPages, this)\n  } catch (e) {\n    DEBUG('dealwithRoute error = %O', e)\n    // console.log(e);\n    // return ctx.redirect('404')\n  }\n}\n\n// 分发路由\nasync function distribute(route, pageData, ctrlPages, routerInstance){\n  let [pdata, rt] = await controler(this, route, pageData, ctrlPages, routerInstance)\n  return await renderPage(this, rt, pdata)\n}\n\n\n// match的control文件，并返回数据\nasync function getctrlData(_path, route, ctx, _pageData, ctrl){\n  try {\n    let _names = []\n    ctrl.set('route', route)\n    if (Array.isArray(_path)) {\n      for (let _filename of _path) {\n        _filename = Path.resolve(__dirname, _filename+'.js')\n        if (fs.existsSync(_filename)) {\n          let _stat = fs.statSync(_filename)\n          if (_stat && _stat.isFile()) _names.push(_filename)\n        }\n      }\n    }\n    if (_names.length) {\n      let controlConfig = require(_names[0]).getData.call(ctx, _pageData)\n      _pageData = await ctrl.run(ctx, controlConfig)\n    } else {\n      _pageData = false\n    }\n    return _pageData\n  } catch (e) {\n    DEBUG('getctrlData error = %O', e)\n    return {nomatch: true}\n  }\n}\n\nasync function controler(ctx, route, pageData, ctrlPages, routerInstance){\n  let routerPrefix = routerInstance.opts.prefix\n  if (_.isString(routerPrefix) && routerPrefix.indexOf('/')==0) routerPrefix = routerPrefix.replace('/','')\n\n  try {\n    let ctrl = control(route, ctx, pageData, routerInstance)\n    let passAccess = false\n    if (ctrl.initStat){\n      pageData = await ctrl.run(ctx)\n      route = ctrl.store.route || route\n    } else {\n\n      let xData = false\n      // 根据route匹配到control文件+三层路由\n      const controlFile = Path.sep+route+'.js'\n      if (ctrlPages.indexOf(controlFile)>-1){\n        xData = await getctrlData([businessPagesPath+'/'+route], route, ctx, pageData, ctrl)\n      }\n      // 根据prefix匹配到control文件+三层路由\n      else if (routerPrefix) {\n        route = routerPrefix\n        let prefixIndexFile =  Path.join(businessPagesPath, routerPrefix, '/index')\n        let prefixCatFile =  Path.join(businessPagesPath, routerPrefix, ctx.params.cat||'')\n        xData = await getctrlData([prefixIndexFile,prefixCatFile], route, ctx, pageData, ctrl)\n      }\n      // pages根目录+三层路由\n      else {\n        if (ctx.params.cat) {\n          let paramsCatFile =  Path.join(businessPagesPath, ctx.params.cat)\n          const xRoute = ctx.params.cat\n          xData = await getctrlData([paramsCatFile], xRoute, ctx, pageData, ctrl)\n        }\n      }\n      // 根据 Fetch.apilist 匹配到api接口，从远程借口拿去数据\n      if (!xData) {\n        let apilist = Fetch.apilist\n        if( apilist.list[route] || route === 'redirect' ){\n          passAccess = true\n          xData = await getctrlData(['./passaccesscontrol'], route, ctx, pageData, ctrl)\n        } else {\n          xData = {nomatch: true}\n        }\n      }\n      const isAjax = ctx.fkp.isAjax()\n      if (passAccess || isAjax) pageData = xData\n    }\n    return [pageData, route]\n  } catch (e) {\n    DEBUG('controler error = %O', e)\n    // console.log(e.stack);\n  }\n}\n\n// dealwith the data from controlPage\nasync function renderPage(ctx, route, data, isAjax){\n  try {\n    DEBUG('renderPage pageData = %O', data)\n    DEBUG('renderPage route = %s', route)\n    switch (ctx.method) {\n      case 'GET':\n        let getStat = ctx.local.query._stat_\n        if ((getStat && getStat === 'DATA') || isAjax ) return ctx.body = data\n        if (data && data.nomatch) throw new Error('你访问的页面/api不存在')\n        return await ctx.render(route, data)\n      case 'POST':\n        return ctx.body = data\n    }\n  } catch (e) {\n    if (isAjax) {\n      ctx.body = {\n        error: '找不到相关信息'\n      }\n    } else {\n      ctx.body = \"<div>找不到页面，呃！</div>\"\n    }\n    // return await ctx.render('404')\n  }\n}\n\ninit.makeRoute = makeRoute\ninit.getRoute = makeRoute\ninit.staticMapper = staticMapper\ninit.renderPage = renderPage\ninit.pages = function(_path){\n  businessPagesPath = _path\n}\n\nmodule.exports = init\n"]}