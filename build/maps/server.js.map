{"version":3,"sources":["server.js"],"names":["app","keys","configs","fkp","server","on","err","ctx","logger","error","_init","global","debug","require","default","aotooServer","opts","middlewares","index","pages","apis","mapper","pluginsFolder","state","views","bodyparser","midw","use","dist","files","dft","dynamic","buffer","gzip","_","merge","obj","map","html","extension","options","call","console","module","exports","e"],"mappings":"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","file":"../server.js","sourcesContent":["import Koa from 'koa'\nimport aotoo from 'aotoo-common'   // global.Aotoo\nimport views from 'koa-views'\nimport statics from 'koa-static-cache'\nimport bodyparser from 'koa-bodyparser'\n\nglobal.debug = require('debug')\nconst fkp = require('./fkpcore').default\nconst app = new Koa()\n\nclass aotooServer {\n  constructor(opts){\n    this.middlewares = []\n    this.configs = {\n      keys: opts.keys||['agzgz gogogo'],\n      index: opts.index||'index',\n      pages: opts.pages,\n      apis: opts.apis||{},\n      mapper: opts.mapper||{},\n      pluginsFolder: opts.pluginsFolder\n    }\n    this.state = {\n      views: false,\n      bodyparser: false\n    }\n  }\n\n  async use(midw){\n    app.use(midw)\n  }\n\n  async statics(dist, opts, files){\n    let dft = {\n      dynamic: false,\n      buffer: false,\n      gzip: false\n    }\n    if (opts) {\n      dft = _.merge(dft, opts)\n    }\n\n    app.use( statics(dist, dft, files) )\n  }\n\n  async apis(obj={}){\n    if (typeof obj == 'object') {\n      this.configs.apis = obj\n    }\n  }\n\n  async bodyparser(obj={}) {\n    if (typeof obj == 'object') {\n      this.state.bodyparser = true\n      app.use( bodyparser(obj) )\n    }\n  }\n\n  async views(dist, opts){\n    let dft = {\n      map: {\n        html: (opts&&opts.html||'ejs')\n      }\n    }\n    if (opts&&opts.extension) {\n      dft.extension = opts.extension\n    }\n    if (opts&&opts.options) {\n      dft.options = opts.options\n    }\n    this.state.views = true\n    app.use( views(dist, dft) )\n  }\n\n  async init(){\n    try {\n      if (!this.state.views) {\n        throw '必须指定模板引擎的views目录'\n      }\n      if (!this.state.bodyparser) {\n        app.use( bodyparser() )\n      }\n      return await _init.call(this)\n      \n    } catch (e) {\n      console.error(e);\n    }\n  }\n}\n\n\nasync function _init() {\n  app.keys = this.configs.keys\n  const server = await fkp(app, this.configs)\n\tapp.on('error', async (err, ctx) => {\n\t\tlogger.error('server error', err, ctx)\n\t})\n\n  return server\n}\n\nmodule.exports = function(opts){\n  try {\n    if (!opts.pages) throw '必须指定 pages 目录选项, pages目录放置control层文件'\n    return new aotooServer(opts)\n  } catch (e) {\n    console.error(e);\n  } \n}\n"]}