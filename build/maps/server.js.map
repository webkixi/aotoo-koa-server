{"version":3,"sources":["server.js"],"names":["myStore","append","entry","configs","keys","apis","mapper","app","list","Error","js","css","call","server","on","err","ctx","console","error","log","stack","_init","global","ReactDomServer","require","SAX","DEFAULTCONFIGS","public","fetchOptions","headers","timeout","cacheOptions","max","length","n","key","dispose","value","maxAge","bodyOptions","aotooServer","opts","middlewares","theApis","index","root","pages","pagesFolder","controls","pluginsFolder","state","views","bodyparser","use","Fetch","fetch","Cache","cache","_public","Aotoo","inject","midw","name","fn","plugins","utileHand","callback","arguments","dist","files","dft","dynamic","buffer","gzip","_","merge","obj","extname","debug","process","env","NODE_ENV","render","viewsRoot","existsSync","distState","statSync","isDirectory","sync","forEach","item","push","port","dom","cb","init","listen","module","exports"],"mappings":"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","file":"../server.js","sourcesContent":["import fs from \"fs\";\nimport glob from \"glob\";\nimport md5 from \"blueimp-md5\";\nimport Koa from 'koa'\nimport aotoo from 'aotoo-common'   // global.Aotoo\nimport render from 'koa-art-template'\nimport statics from 'koa-static-cache'\nimport bodyparser from 'koa-bodyparser'\nimport core, { fkp } from './fkpcore'\nimport fetch from './fkpcore/modules/fetch'\nimport cache from './fkpcore/modules/cache'\nglobal.ReactDomServer = require('react-dom/server')\n\nconst myStore = SAX('AOTOO-KOA-SERVER')\n\nconst app = new Koa()\nconst DEFAULTCONFIGS = {\n  mapper: {\n    js: {},\n    css: {},\n    public: {\n      js: '/js',\n      css: '/css'\n    }\n  },\n  \n  apis: {\n    list: {}\n  },\n\n  fetchOptions: {\n    headers: { }\n    , timeout: 10000\n  },\n\n  cacheOptions: {\n    max: 300\n    , length: function (n, key) { return n * 2 + key.length }\n    , dispose: function (key, value) { }\n    , maxAge: 2 * 60 * 60 * 1000\n  },\n\n  bodyOptions: {}\n}\n\n\nclass aotooServer {\n  constructor(opts = {}) {\n    this.middlewares = []\n\n    let theApis = {\n      list: opts.apis || {}\n    }\n\n    this.configs = {\n      keys: opts.keys || ['aotoo koa'],    // cookie session关键字\n      index: opts.index || 'index',        // 默认首页\n\n      apis: theApis || DEFAULTCONFIGS.apis,                      // api接口集合\n      mapper: opts.mapper || DEFAULTCONFIGS.mapper,  // 静态资源映射文件\n\n      fetchOptions: opts.fetchOptions || DEFAULTCONFIGS.fetchOptions,\n      cacheOptions: opts.cacheOptions || DEFAULTCONFIGS.cacheOptions,\n      bodyOptions: opts.bodyOptions || DEFAULTCONFIGS.bodyOptions,\n\n      root: opts.root,              // 渲染默认目录\n      pages: opts.pages||opts.pagesFolder||opts.controls,        // control层文件夹，必须\n      pluginsFolder: opts.pluginsFolder   // 插件文件夹\n    }\n\n    this.state = {\n      views: false,\n      bodyparser: false\n    }\n\n    if (this.configs.bodyOptions) {\n      this.state.bodyparser = true\n      app.use(bodyparser(this.configs.bodyOptions))\n    }\n\n    // 传入apis\n    global.Fetch = this.fetch = fetch({ apis: this.configs.apis, ...this.fetchOptions});\n    global.Cache = this.cache = cache(this.cacheOptions)\n\n    if (this.configs.mapper) {\n      let _public\n      let mapper = this.configs.mapper\n      if (mapper.public) {\n        _public = mapper.public\n        // delete mapper.public\n      }\n      if (_public) {\n        Aotoo.inject.public = _public\n      }\n      Aotoo.inject.mapper = mapper\n    }\n  }\n\n  public(opts) {\n    Aotoo.inject.public = opts\n  }\n\n  // 注册KOA2的中间间，与KOA2语法保持一致\n  async use(midw) {\n    app.use(midw)\n  }\n\n  // 注册一个Aotoo插件方法\n  plugins(name, fn) {\n    fkp.plugins(name, fn)\n  }\n\n  // 注册一个Aotoo助手方法\n  utile(name, fn) {\n    fkp.utileHand(name, fn)\n  }\n\n  callback() {\n    return app.callback(arguments)\n  }\n\n  // 指定站点静态路径，如 /images, /uploader, /user\n  async statics(dist, opts, files) {\n    let dft = {\n      dynamic: false,\n      buffer: false,\n      gzip: false\n    }\n    if (opts) {\n      dft = _.merge(dft, opts)\n    }\n\n    app.use(statics(dist, dft, files))\n  }\n\n  // 注册api接口集，用于做接口层的数据访问\n  async apis(obj = {}) {\n    if (typeof obj == 'object') {\n      this.configs.apis = obj\n    }\n  }\n\n\n  // 注册POST中间件，可以通过 ctx.bodys来访问post数据\n  async bodyparser(obj = {}) {\n    if (typeof obj == 'object') {\n      this.state.bodyparser = true\n      app.use(bodyparser(obj))\n    }\n  }\n\n\n  // 注册渲染方法\n  async views(dist, opts) {\n    // import views from 'koa-views'   // 放到顶部\n    // let dft = {\n    //   map: {\n    //     html: (opts&&opts.html||'ejs')\n    //   }\n    // }\n    // if (opts&&opts.extension) {\n    //   dft.extension = opts.extension\n    // }\n    // if (opts&&opts.options) {\n    //   dft.options = opts.options\n    // }\n    // this.state.views = true\n    // app.use( views(dist, dft) )\n\n    let dft = {\n      root: dist,\n      extname: '.html',\n      debug: process.env.NODE_ENV !== 'production'\n    }\n\n    if (typeof opts == 'function') {\n      opts = {\n        render: opts\n      }\n    }\n\n    dft = _.merge({}, dft, opts)\n\n    if (dist) {\n      let views = []\n      this.state.viewsRoot = dist\n      if (fs.existsSync(dist)) {\n        const distState = fs.statSync(dist)\n        if (distState.isDirectory()) {\n          glob.sync(dist + '/**/*.html').forEach(function (item) {\n            views.push(item)\n          })\n        }\n      }\n      this.state.views = views\n    }\n    if (dft.render && typeof dft.render == 'function') {\n      app.use(dft.render)\n    } else {\n      render(app, dft)\n    }\n  }\n\n\n  // 初始化\n  async init() {\n    try {\n      if (!this.configs.pages) {\n        throw new Error('控制器目录没有指定')\n      }\n      if (!this.state.views) {\n        if (!this.configs.root) {\n          throw new Error('koa的模板解析引擎没有配置且需设置app.state.views=true; app.state.viewsRoot=HTMLDIST')\n        } else {\n          this.views(this.configs.root)\n        }\n      }\n      if (!this.state.bodyparser) {\n        app.use(bodyparser())\n      }\n      return await _init.call(this)\n\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  async listen(port, dom, cb) {\n    const server = await this.init()\n    server.listen(port, dom, cb)\n  }\n}\n\n\nasync function _init() {\n  try {\n    myStore.append({ entry: this })\n    const {keys, apis, mapper} = this.configs\n    app.keys = this.configs.keys\n\n    if (!apis.list) {\n      throw new Error('api 列表必须封装为list的子属性')\n    }\n\n    if (!mapper.js || !mapper.css) {\n      throw new Error('请将静态资源列表分别配置作为mapper.js和mapper.css的子元素')\n    }\n\n    const server = await core.call(this, app, this.configs)\n    app.on('error', async (err, ctx) => {\n      console.error('server error', err, ctx)\n    })\n  \n    return server\n  } catch (error) {\n    console.log(error.stack);\n  }\n}\n\nmodule.exports = function (opts) {\n  return new aotooServer(opts)\n}\n"]}